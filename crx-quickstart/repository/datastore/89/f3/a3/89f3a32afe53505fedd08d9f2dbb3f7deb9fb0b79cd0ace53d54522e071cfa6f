/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2018 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(b){b.pkg("s7sdk.video");b.Util.require("s7sdk.common.ItemDesc");b.Util.require("s7sdk.common.IS");b.Util.require("s7sdk.common.IconEffect");b.Util.require("s7sdk.common.Enumeration");b.Util.require("s7sdk.event.Event");b.Util.require("s7sdk.event.PanoramicController");b.Util.require("s7sdk.video.VideoProxies");b.Util.require("s7sdk.libs.three.three");b.Util.require("s7sdk.video.qosMetric");if(!b.video.playbackType){b.video.playbackType={AUTO:"auto",HLS:"hls",DASH:"dash",PROGRESSIVE:"progressive",NATIVE:"native",FLASH:"flash"}}if(!b.video.Video360PlayerControl){b.video.Video360PlayerControl=function(c){arguments.callee.superclass.apply(this,[c,b.video.Video360PlayerControl.NS,c.constructor,b.video.Video360Player.RESTRICTED_STYLES])};b.video.Video360PlayerControl.NS="s7sdk.video.Video360PlayerControl";b.video.Video360PlayerControl.prototype.setModifier=function(f){var c;for(var e in f){var d=e.toLowerCase();if(d=="mutevolume"){value=f[e];if(value){this.component.mute()}else{this.component.unmute()}}else{if(!c){c={}}c[e]=f[e]}}if(c){this.superclass.prototype.setModifier.apply(this,[c])}};b.video.Video360PlayerControl.prototype.rebuild=function(s){if(this.component){var d=this.component.getVolume();var q=this.component.muted();var f=this.component.viewReadyEventSent;var m=this.component.metadataReadyEventSent;var o=this.component.assetSpecificPosterImage;var n=s["posterimage"];s["posterimage"]=n?n:this.component.posterimage;var i=s["asset"];var c=s["video"];var k;var l=this.component.getCurrentAsset()?true:false;if(i){k=i;delete s["asset"];f=false;m=false;l=true}else{if(c){k=c;delete s["video"];f=false;m=false;l=false}else{if(l){k=this.component.getCurrentAsset()}else{k=this.component.getCurrentVideo()}}}var r,p,e;if((typeof this.component.getWidth=="function")&&(typeof this.component.getHeight=="function")){r=this.component.getWidth();p=this.component.getHeight()}var j,h;if(this.restrictedStylesValues[this.getCl()]){j=this.restrictedStylesValues[this.getCl()].width;h=this.restrictedStylesValues[this.getCl()].height}this.listenerProxy=b.Util.copyListeners(this.component);this.unload();this.component=new this.componentconstructor(this.parentId,s,this.compId,true);this.component.allowInitialUserEvent=false;this.restrictedStylesValues=this.readRestrictedStylesValues();var g=false;if(j&&h&&this.restrictedStylesValues[this.getCl()]){g=(j!=this.restrictedStylesValues[this.getCl()].width);g=g||(h!=this.restrictedStylesValues[this.getCl()].height)}if(!g&&(typeof this.component.resize=="function")){this.component.resize(r,p)}b.Util.assignListeners(this.listenerProxy,this.component);delete s["posterimage"];if(this.component.assetSpecificPosterImage){o=this.component.assetSpecificPosterImage}else{if(n&&n.toLowerCase()=="none"){o=undefined}}if(l){this.component.setCurrentAsset(k,o)}else{this.component.setCurrentVideo(k,o)}this.component.setVolume(d);if(q){this.component.mute()}else{this.component.unmute()}this.component.viewReadyEventSent=f;this.component.metadataReadyEventSent=m}};b.video.Video360PlayerControl.prototype.setVRRender=function(d){if(this.component){var c=(this.dynamicModifiers?this.dynamicModifiers:b.Util.resolveModifier("","",this.component,this.component.settings));c["vrrender"]=d?"true":"false";this.rebuild(c)}}}b.Class.inherits(b.video.Video360PlayerControl.NS,"s7sdk.ControlComponent");if(!b.video.Video360Player){b.video.Video360Player=function Video360Player(c,e,k){var h=!!arguments[3];arguments.callee.superclass.apply(this,[k,c,"div","s7video360player",e,!h]);var l=this;if("xr" in navigator&&"requestDevice" in navigator.xr){navigator.xr.requestDevice().then(function(m){l.setVR()})}else{if("getVRDisplays" in navigator){navigator.getVRDisplays().then(function(m){if(m.length>0){l.setVR()}})}}this.createElement();this.container=this.getParent();this.videoServerUrl=b.Util.normalizeUrl(this.videoServerUrl);if(this.video){this.playback.type=b.Util.getVideoPlaybackTypeFromUrl(this.video)}if(/(https?:\/\/[^\/]*)\b(\/DMGateway\/(private)\/)/.test(this.videoServerUrl)){this.videoServerUrl=this.videoServerUrl.replace(/(https?:\/\/[^\/]*)(\/[^\/]*)(\/private\/)/g,"$1$2/private-ssl/")}if(/(https?:\/\/[^\/]*)\b(\/DMGateway\/(public)\/)/.test(this.videoServerUrl)){this.videoServerUrl=this.videoServerUrl.replace(/(https?:)(\/\/[^\/]*)(\/[^\/]*)(\/public\/)/g,(((this.ssl=="on")||(b.browser.name=="ie"&&b.browser.version.minor==11&&(typeof(MediaSource)!="undefined")&&this.playback.type===b.video.playbackType.AUTO))?"https:$2$3/public-ssl/":location.protocol+"$2$3$4"));this.videoServerUrl=this.videoServerUrl.replace(/(https:\/\/[^\/]*)(\/[^\/]*)(\/public\/)/g,"$1$2/public-ssl/")}this.compId=(b.Util.isNull(k)?"":k);this.videoItem=null;this.serverDuration=undefined;this.curMilestone=undefined;this.seekTime=undefined;this.methodCallQueue=[];this.setRequestLoaded=true;this.viewReadyEventSent=false;this.metadataReadyEventSent=false;this.texture=null;this.material=null;this.scene=null;this.geometry=null;this.renderer=null;this.effect=null;this.mesh=null;this.camera=null;this.lon=this.lat=0;this.distance=50;this.helperCanvas=null;this.helperImage=null;this.hasVideoTexture=false;this.allowInitialUserEvent=true;this.endNotificationSent=false;this.assetSpecificPosterImage=undefined;this.videoCapabilityState=new b.VideoCapabilityState();this.wid=this.size.width;this.hei=this.size.height;if(this.wid==0||this.hei==0){this.wid=parseInt(b.Util.css.getCss("s7video360player","width",this.compId,null,this.container));this.hei=parseInt(b.Util.css.getCss("s7video360player","height",this.compId,null,this.container));if(!b.Util.isNumber(this.wid)||!b.Util.isNumber(this.hei)||this.wid<=0||this.hei<=0){if("clientHeight" in this.container&&"clientWidth" in this.container){this.wid=this.container.clientWidth;this.hei=this.container.clientHeight}if(this.wid==0||this.hei==0){this.wid=400;this.hei=300}}}this.obj.style.width=this.wid+"px";this.obj.style.height=this.hei+"px";if(!this.hint){this.hint=document.createElement("span");this.hint.id=this.id+"_hint";this.hint.style.display="none";this.hint.innerText=this.getLocalizedText("USAGE_HINT");this.obj.appendChild(this.hint)}this.obj.setAttribute("tabindex",0);this.obj.setAttribute("role","application");this.obj.setAttribute("aria-roledescription",this.getLocalizedText("ROLE_DESCRIPTION"));this.obj.setAttribute("aria-describedby",this.hint.id);this.clickToPlay=0;if((/play/i).test(this.singleclick)){this.clickToPlay=1}this.serverUrl=b.Util.normalizeUrl(this.serverUrl);this.attachToContainer();this.videoProxy=this.resolveVideoProxy();if(this.vrRender){function j(){var m;m=document.createElement("button");m.id=l.id+"_specbtn";m.className="s7trackdeviceorientationbutton";m.textContent=l.getLocalizedText("TRACK_DEVICE_ORIENTATION");m.style.display="none";return m}function i(n){n.style.display="block";var m=n;n.onclick=n.ontouchend=function(o){b.Event.preventDefault(o);window.DeviceOrientationEvent.requestPermission()["then"](function(p){if(p=="granted"){g(m)}else{g(m)}})["catch"](function(p){g(m)})}}function g(m){m.style.display="none";m.onclick=null;m.ontouchend=null}var d=j();this.obj.appendChild(d);if(window.DeviceOrientationEvent!==undefined&&typeof window.DeviceOrientationEvent.requestPermission==="function"){i(d)}else{g(d)}}this.create360Video();this.onTogglePauseHandler=function(m){if(!l.control.isMoving&&window.MouseEvent&&m instanceof MouseEvent){l.togglePause()}};this.onClickHandler=function(m){b.Event.dispatch(l.obj,b.Event.CLICK,false)};this.onTouchEndHandler=function(m){if(window.TouchEvent&&m instanceof TouchEvent){l.ovlInTouch=true}};this.onTouchClickHandler=function(m){if(!l.control.isMoving&&window.TouchEvent&&m instanceof TouchEvent){if(l.ovlInTouch){l.togglePause()}l.ovlInTouch=false}};if(this.clickToPlay&&!this.hasNativeControls()){b.Event.addDOMListener(this.obj,"click",l.onTouchClickHandler);b.Event.addDOMListener(this.obj,"click",l.onTogglePauseHandler)}if(!this.hasNativeControls()){b.Event.addDOMListener(this.obj,"click",l.onClickHandler)}this.keyDownHandler=function(m){var n=(m.which)?m.which:m.keyCode;if(n==b.Enum.KEY_CODE.TAB){return}if((n==b.Enum.KEY_CODE.ENTER)||(n==b.Enum.KEY_CODE.SPACE)){b.Event.preventDefault(m);l.togglePause()}};this.obj.addEventListener("keydown",this.keyDownHandler,true);this.addEventListener(b.event.CapabilityStateEvent.NOTF_VIDEO_CAPABILITY_STATE,function(m){l.onCapabilityState(m)},false);this.createIconEffect();this.createWaitIcon();var f=unescape(this.asset);if(f!=""&&this.video==""){this.setAsset(f,this.posterimage)}if(this.video!=""){this.setVideo(this.video,this.posterimage)}if(this.posterimage&&this.posterimage!=""){if(this.posterimage.indexOf("?")!=0&&this.posterimage!="none"){this.assetSpecificPosterImage=this.posterimage;this.posterimage=""}else{this.assetSpecificPosterImage=undefined}}if(!h){return new b.video.Video360PlayerControl(this)}else{return this}};b.Class.inherits("s7sdk.video.Video360Player","s7sdk.UIComponent");b.video.Video360Player.prototype.symbols={ERROR:"Your Browser does not support HTML5 Video tag or the video cannot be played.",ROLE_DESCRIPTION:"360 Video",USAGE_HINT:"Use arrow keys to navigate in 360 Video",TRACK_DEVICE_ORIENTATION:"Track device orientation"};b.video.Video360Player.prototype.setModifier=function(c){throw new Error("Trying to use setModifier on the Core class (Video360Player) is unsupported! Please refer to SDK documentation on using setModifier.")};b.video.Video360Player.prototype.modifiers={serverUrl:{params:["isRootPath"],defaults:["/is/image/"]},videoServerUrl:{params:["value"],defaults:["/is/content/"]},contentUrl:{params:["value"],defaults:["/is/content/"]},size:{params:["width","height"],defaults:[0,0],ranges:["0:","0:"]},asset:{params:["value"],defaults:[""]},autoplay:{params:["enabled"],defaults:[true]},singleclick:{params:["singleclick"],defaults:["playPause"],ranges:[["none","playPause"]]},iconEffect:{params:["enabled","count","fade","autoHide"],defaults:[true,1,0.3,3],ranges:[null,"-1:","0:","0:"]},playback:{params:["type","controls"],defaults:[b.video.playbackType.AUTO,false],ranges:[[b.video.playbackType.AUTO,b.video.playbackType.HLS,b.video.playbackType.DASH,b.video.playbackType.PROGRESSIVE]]},progressivebitrate:{params:["value"],defaults:[700],ranges:["1:"]},initialbitrate:{params:["value"],defaults:[0],ranges:["0:"]},aemmode:{params:["value"],defaults:[false],ranges:[[true,false]]},loop:{params:["enabled"],defaults:[false]},video:{params:["value"],defaults:[""],parseParams:false},ssl:{params:["value"],defaults:["auto"],ranges:[["auto","on"]],deprecated:true},waiticon:{params:["enabled"],defaults:[true]},preload:{params:["enabled"],defaults:[true]},mutevolume:{params:["enabled"],defaults:[false],ranges:[[true,false]]},posterimage:{params:["posterimage"],defaults:[""]},autoRotate:{params:["enabled"],defaults:[true]},vrRender:{params:["enabled"],defaults:[false]}};b.video.Video360Player.RESTRICTED_STYLES={"s7video360player":["width","height"],"s7video360player s7iconeffect":["width","height"]};b.video.Video360Player.prototype.addEventListener=function(e,d,c){this.superproto.addEventListener.apply(this,[e,d,c])};b.video.Video360Player.prototype.create360Video=function(){var c=this;this.camera=new b.libs.three.THREE.PerspectiveCamera(75,this.wid/this.hei);this.camera.target=new b.libs.three.THREE.Vector3(0,0,0);this.scene=new b.libs.three.THREE.Scene();this.geometry=new b.libs.three.THREE.SphereBufferGeometry(500,60,40);this.geometry.scale(-1,1,1);this.renderer=new b.libs.three.THREE.WebGLRenderer({antialias:true});this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.vr.enabled=true;this.obj.appendChild(this.renderer.domElement);this.effect=new b.libs.three.THREE.StereoEffect(this.renderer);this.control=new b.event.PanoramicController(this.camera,this.obj,(this.autoRotate&&!this.autoplay));this.control.autoRotateSpeed=0.5;this.prevPOV=this.getPov();this.control.onChangeCallback=function(){var e=c.getPov();if(e.lon!=c.prevPOV.lon||e.lat!=c.prevPOV.lat){c.dispatchEvent(new b.event.PovEvent(b.event.PovEvent.NOTF_POV_CHANGE,e));c.prevPOV=e}};if((this.posterimage!="none"&&this.posterimage!="")&&!this.autoplay){this.helperCanvas=b.Util.createElement("canvas");this.helperImage=null;this.helperImage=new Image();this.helperImage.crossOrigin="anonymous";this.texturePosterImageLoaded=false;this.helperImage.onload=function(){d()}}else{this.createVideoTexture();this.updateTexture()}this.videoQosMetric=new b.video.QosMetric(this);function d(){c.videoProxy.onViewReady();if(c.helperCanvas){c.helperCanvas.width=c.helperImage.width;c.helperCanvas.height=c.helperImage.height}var e=c.helperCanvas.getContext("2d");e.drawImage(c.helperImage,0,0);c.texture=new b.libs.three.THREE.CanvasTexture(c.helperCanvas);c.texture.generateMipmaps=false;c.texture.minFilter=b.libs.three.THREE.LinearFilter;c.texture.magFilter=b.libs.three.THREE.LinearFilter;c.texture.format=b.libs.three.THREE.RGBFormat;c.hasVideoTexture=false;c.texturePosterImageLoaded=true;c.updateTexture()}};b.video.Video360Player.prototype.createVideoTexture=function(){this.texture=new b.libs.three.THREE.VideoTexture(this.videoProxy.getVideoElement());this.texture.generateMipmaps=false;this.texture.minFilter=b.libs.three.THREE.LinearFilter;this.texture.magFilter=b.libs.three.THREE.LinearFilter;this.texture.format=b.libs.three.THREE.RGBFormat;this.hasVideoTexture=true};b.video.Video360Player.prototype.updateTexture=function(){var c=this;if(this.mesh){this.scene.remove(this.mesh)}if(this.material){this.material.dispose()}this.material=new b.libs.three.THREE.MeshBasicMaterial({map:this.texture});this.mesh=new b.libs.three.THREE.Mesh(this.geometry,this.material);this.mesh.id=this.id+"_mesh";this.scene.add(this.mesh);this.render=this.render.bind(this);this.renderer.setAnimationLoop(this.render);this.setOrientationControls_=function(d){c.setOrientationControls(d)};window.addEventListener("deviceorientation",this.setOrientationControls_,true)};b.video.Video360Player.prototype.clearSphere=function(){this.control.dispose();this.scene.remove(this.mesh);this.geometry.dispose();if(this.material){this.material.dispose()}if(this.texture){this.texture.dispose()}this.renderer.dispose();this.obj.removeChild(this.renderer.domElement);this.control=null;this.camera=null;this.scene=null;this.geometry=null;this.texture=null;this.material=null;this.mesh=null;this.renderer=null;this.effect=null};b.video.Video360Player.prototype.render=function(){if(this.control){this.control.update()}if(this.texture){this.texture.needsUpdate=true}if(this.mesh&&((this.scene.getObjectById(this.mesh.id).material.map.image.readyState>=this.scene.getObjectById(this.mesh.id).material.map.image.HAVE_CURRENT_DATA)||this.texturePosterImageLoaded)){if(this.vrRender&&this.effect){this.effect.render(this.scene,this.camera)}else{if(this.renderer){this.renderer.render(this.scene,this.camera)}}}};b.video.Video360Player.prototype.getCurrentAsset=function(){return this.currentAsset};b.video.Video360Player.prototype.setCurrentAsset=function(d,c){this.assetSpecificPosterImage=c;if(typeof(d)=="string"){this.setAsset(d,c)}else{if(this.isReq_){this.isReq_.cancelHttpReq()}this.currentAsset=d;this.createViewer(d)}};b.video.Video360Player.prototype.getCurrentVideo=function(){return this.currentVideo};b.video.Video360Player.prototype.setCurrentVideo=function(d,c){this.assetSpecificPosterImage=c;if(typeof(d)=="string"){this.setVideo(d,c)}};b.video.Video360Player.prototype.onCapabilityState=function(c){var d=c.s7event.state;if(d.hasCapability(b.VideoCapabilityState.PAUSE)){if(this.iconEffectObj){this.iconEffectObj.hide()}this.showWaitIcon(this.videoProxy.isBuffering())}if(d.hasCapability(b.VideoCapabilityState.PLAY)){if(this.iconEffectObj){this.showWaitIcon(false);this.iconEffectObj.show(this.wid,this.hei);b.Util.css.setCSSAttributeSelector(this.iconEffectObj.obj,"state","play")}}if(d.hasCapability(b.VideoCapabilityState.REPLAY)){if(this.iconEffectObj){this.showWaitIcon(false);this.iconEffectObj.show(this.wid,this.hei);b.Util.css.setCSSAttributeSelector(this.iconEffectObj.obj,"state","replay")}}};b.video.Video360Player.prototype.getWidth=function(){return this.wid};b.video.Video360Player.prototype.getHeight=function(){return this.hei};b.video.Video360Player.prototype.resize=function(d,e){var c,f;this.wid=d>0?d:1;this.hei=e>0?e:1;this.videoProxy.resize(this.wid,this.hei);this.obj.style.width=this.wid+"px";this.obj.style.height=this.hei+"px";if(this.iconEffectObj&&this.iconEffectObj.enabled){this.iconEffectObj.centerOverlay(d,e)}this.updateSize(d,e);b.UIComponent.prototype.resize.apply(this,[d,e]);b.Logger.log(b.Logger.INFO,"Video360Player.resize( %0 %1 )",d,e)};b.video.Video360Player.prototype.updateSize=function(d,e){var f;var c;if(this.videoProxy.getVideoWidth()&&this.videoProxy.getVideoHeight()){c=d*this.videoProxy.getVideoHeight()/this.videoProxy.getVideoWidth();if(c>e){f=this.videoProxy.getVideoWidth()*e/this.videoProxy.getVideoHeight();c=e}else{f=d}}else{c=e;f=d}if(this.vrRender){this.camera.aspect=this.getWidth()/this.getHeight()}else{this.camera.aspect=f/c}this.camera.updateProjectionMatrix();this.renderer.setSize(this.getWidth(),this.getHeight());this.effect.setSize(this.getWidth(),this.getHeight());this.renderer.setViewport((d-f)/2,(e-c)/2,f,c)};b.video.Video360Player.prototype.supportsInline=function(){b.Logger.log(b.Logger.INFO,"Video360Player.supportsInline() = %0",!((b.browser.device.name=="android"&&b.browser.device.version<4)||b.browser.device.name=="iphone"));return !((b.browser.device.name=="android"&&b.browser.device.version<4)||(b.browser.device.name=="iphone"&&b.browser.device.version<10))};b.video.Video360Player.prototype.getAsset=function(){var c=(this.videoItem==null?null:this.videoItem.name);b.Logger.log(b.Logger.INFO,"Video360Player.getAsset() = %0",c);return c};b.video.Video360Player.prototype.setAsset=function(f,c){this.metadataReadyEventSent=false;this.viewReadyEventSent=false;this.setRequestLoaded=false;this.methodCallQueue.splice(0,this.methodCallQueue.length);this.resetQosMetric();var d=new b.event.VideoEvent(b.event.VideoEvent.NOTF_CURRENT_TIME,0,true);this.dispatchEvent(d,false);var e=new b.UserEvent(b.UserEvent.CURRENT_TIME,0,true);this.dispatchEvent(e,false);this.assetSpecificPosterImage=c;this.currentAsset=f;this.loadAsset(f);b.Logger.log(b.Logger.INFO,"Video360Player.setAsset( %0 )",f+(c?", "+c:""))};b.video.Video360Player.prototype.setVideo=function(e,c){this.metadataReadyEventSent=false;this.viewReadyEventSent=false;this.setRequestLoaded=true;this.methodCallQueue.splice(0,this.methodCallQueue.length);this.resetQosMetric();var d=new b.event.VideoEvent(b.event.VideoEvent.NOTF_CURRENT_TIME,0,true);this.dispatchEvent(d,false);var g=new b.UserEvent(b.UserEvent.CURRENT_TIME,0,true);this.dispatchEvent(g,false);this.assetSpecificPosterImage=c;var f=b.Util.getVideoPlaybackTypeFromUrl(e);if(this.playback.type!==f){this.playback.type=f;this.videoQosMetric.dispose();this.videoProxy.dispose();this.clearSphere();this.videoProxy=this.resolveVideoProxy();this.create360Video()}this.currentVideo=e;this.videoProxy.setVideo(e);b.Logger.log(b.Logger.INFO,"Video360Player.videoName( %0 )",e+(c?", "+c:""))};b.video.Video360Player.prototype.loadAsset=function(c){b.Logger.log(b.Logger.INFO,"Video360Player.loadAsset");var d=b.Util.resolveURL(this.serverUrl,b.MediaSetParser.parseAssetForSetReq(c).req);if(b.Util.isNonEmptyString(this.locale)){d+="&locale="+this.locale}if(this.isReq_){this.isReq_.cancelHttpReq()}this.isReq_=new b.IS();this.isReq_.getHttpReq(d,function(f,e){b.video.Video360Player.prototype.setRequestComplete.apply(e,[f])},function(f,e){b.video.Video360Player.prototype.setRequestError.apply(e,[f,c])},this)};b.video.Video360Player.prototype.setRequestComplete=function(d){var i=this.videoItem;var c=d.set;if(c==null){return}var g=b.MediaSetParser.parse(c,"");switch(g.type){case b.ItemDescType.VIDEO_SET:this.createViewer(g);break;case b.ItemDescType.VIDEO:this.createViewer(g.items[0]);break;case b.ItemDescType.VIDEO_GROUP:this.createViewer(g);break;default:throw new Error("parsed media set is of wrong type: "+g.type)}this.setRequestLoaded=true;while(this.methodCallQueue.length>0){var f=this.methodCallQueue[0];this.methodCallQueue.splice(0,1);this[f.func].apply(this,f.args)}if(!this.metadataReadyEventSent){var e=new b.event.StatusEvent(b.event.StatusEvent.NOTF_ASSET_METADATA_READY,true);b.Event.dispatch(this.obj,e,false);this.metadataReadyEventSent=true}if(i!=null){var h=new b.UserEvent(b.UserEvent.SWAP,[0,this.videoItem],true);this.dispatchEvent(h,false)}};b.video.Video360Player.prototype.createViewer=function(c){this.videoCapabilityState=new b.VideoCapabilityState();this.endNotificationSent=false;this.setAssetInternal(c);this.settings.trackLoad(this);if(this.allowInitialUserEvent){if(this.autoplay){var e=new b.UserEvent(b.UserEvent.PLAY,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(e,false)}this.allowInitialUserEvent=false}var d=new b.event.AssetEvent(b.event.AssetEvent.ASSET_CHANGED,c,this.getIndexFromItem(c),true);this.dispatchEvent(d)};b.video.Video360Player.prototype.getIndexFromItem=function(f){if(f.parent!=null){var e=-1;var d=f.parent.items;for(var c=0;c<d.length;c++){if(d[c].name==f.name){e=c;break}}return e}else{return 0}};b.video.Video360Player.prototype.createIconEffect=function(){if(this.clickToPlay&&!this.hasNativeControls()){this.iconEffectObj=new b.IconEffect(this,this.iconEffect.enabled,this.iconEffect.count,this.iconEffect.fade,this.iconEffect.autoHide);if(this.autoplay){this.iconEffectObj.hide();this.showWaitIcon(this.videoProxy.isBuffering())}}};b.video.Video360Player.prototype.createWaitIcon=function(){if(this.waiticon){this.waitIconObj=document.createElement("div");this.waitIconObj.className="s7waiticon";this.waitIconObj.style.visibility="hidden";if(this.obj){this.obj.appendChild(this.waitIconObj)}}};b.video.Video360Player.prototype.hasNativeControls=function(){if((b.browser.device.name=="android"&&b.browser.device.version<4)||this.playback.controls){return true}else{return false}};b.video.Video360Player.prototype.resolveVideoProxy=function(){var h;var c=/^((http|https):\/\/[^\/]*)\b(\/DMGateway\/(private-ssl|private)\/)/.test(this.videoServerUrl);var e=this.isStreamingPlaybackType(this.playback.type);var g=e&&!c&&typeof(MediaSource)!=="undefined";var d="safari"===b.browser.name||"ipad"===b.browser.device.name;if(b.browser.device.name=="iphone"){h=this.buildIphoneVideoProxy()}else{if(g&&!d){h=this.buildVideojsProxy()}else{h=this.buildHTML5VideoProxy()}}var f=this;h.onCurrentTime=function(){if(!f.endNotificationSent){f.checkTimingEvents()}f.checkState();if(!f.endNotificationSent){var i=new b.event.VideoEvent(b.event.VideoEvent.NOTF_CURRENT_TIME,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(i,false);var k=new b.UserEvent(b.UserEvent.CURRENT_TIME,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(k,false);if(f.pendingStopNotification){f.pendingStopNotification=false;var k=new b.UserEvent(b.UserEvent.STOP,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(k,false)}if(f.videoProxy.ended()){f.endNotificationSent=true;var j=new b.event.VideoEvent(b.event.VideoEvent.NOTF_VIDEO_END,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(j,false);var k=new b.UserEvent(b.event.UserEvent.PLAYBACK_COMPLETE,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(k)}}};h.onDuration=function(){f.checkState();var j=new b.event.UserEvent(b.UserEvent.METADATA,["DURATION",f.videoProxy.getDuration()],true);f.dispatchEvent(j,false);var i=new b.event.VideoEvent(b.event.VideoEvent.NOTF_DURATION,f.videoProxy.getDuration(),true);f.dispatchEvent(i,false)};h.onVideoDimension=function(){f.updateSize(f.getWidth(),f.getHeight());if(f.mesh&&f.scene.getObjectById(f.mesh.id).material.map.image.readyState>=f.scene.getObjectById(f.mesh.id).material.map.image.HAVE_CURRENT_DATA){if(f.vrRender){f.effect.render(f.scene,f.camera)}else{f.renderer.render(f.scene,f.camera)}}};h.onLoadProgress=function(){f.checkState();var i=new b.event.VideoEvent(b.event.VideoEvent.NOTF_LOAD_PROGRESS,f.videoProxy.getLoadedPosition(),true);f.dispatchEvent(i,false)};h.onVolume=function(){f.checkState();var i=new b.event.VideoEvent(b.event.VideoEvent.NOTF_VOLUME,f.videoProxy.getVolume(),true);f.dispatchEvent(i,false)};h.onSeeked=function(){var k=f.videoProxy.getCurrentTime();if(k!=f.videoProxy.getDuration()){if(f.videoProxy.paused()&&f.iconEffectObj){if(f.waitIconObj){f.showWaitIcon(false)}f.iconEffectObj.show(this.wid,this.hei)}}if(k!=f.seekTime){var l=new b.event.VideoEvent(b.event.VideoEvent.NOTF_SEEK,f.videoProxy.getCurrentTime(),true);f.dispatchEvent(l,false);var j=new b.event.UserEvent(b.UserEvent.METADATA,["SEEK",f.videoProxy.getCurrentTime()],true);f.dispatchEvent(j,false)}f.seekTime=f.videoProxy.getCurrentTime();var i=new b.event.VideoEvent(b.event.VideoEvent.NOTF_CURRENT_TIME,f.seekTime,true);f.dispatchEvent(i,false);var j=new b.UserEvent(b.UserEvent.CURRENT_TIME,f.seekTime,true);f.dispatchEvent(j,false)};h.onStateChange=function(){f.checkState()};h.onViewReady=function(){if(!f.viewReadyEventSent){var i=new b.event.StatusEvent(b.event.StatusEvent.NOTF_VIEW_READY,true);b.Event.dispatch(f.obj,i,false)}f.viewReadyEventSent=true};h.onBuffering=function(i){f.showWaitIcon(i)};h.isBuffering=function(){return f.isbuffering};h.onPlaybackError=function(j){var i=j.type?"Type: "+j.type+", Details: "+j.message:j;var k=new b.UserEvent(b.event.UserEvent.PLAYBACK_ERROR,i,true);f.dispatchEvent(k);if(j.type===b.video.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED||(!f.videoProxy.getIsProxyready()&&j.type===b.video.MediaError.MEDIA_ERR_NETWORK)){f.onManifestLoadError()}};return h};b.video.Video360Player.prototype.buildHTML5VideoProxy=function(){return new b.video.HTML5VideoProxy(this.wid,this.hei,this.serverUrl,this.videoServerUrl,this.autoplay,this.playback,this.progressivebitrate,this.loop,this.preload,this.mutevolume,this.getLocalizedText("ERROR"),this.aemmode,true)};b.video.Video360Player.prototype.buildIphoneVideoProxy=function(){return new b.video.IPhoneProxy(this.obj,this.wid,this.hei,this.serverUrl,this.videoServerUrl,this.autoplay,this.playback,this.progressivebitrate,this.loop,this.preload,this.mutevolume,this.getLocalizedText("ERROR"),this.aemmode,true)};b.video.Video360Player.prototype.buildVideojsProxy=function(){return new b.video.VideojsProxy(this.wid,this.hei,this.serverUrl,this.videoServerUrl,this.autoplay,this.playback,this.progressivebitrate,this.initialbitrate,this.loop,this.preload,this.mutevolume,this.getLocalizedText("ERROR"),this.aemmode,true)};b.video.Video360Player.prototype.setRequestError=function(c){b.Logger.log(b.Logger.ERROR,"setRequestError %0",c)};b.video.Video360Player.prototype.setAssetInternal=function(f){function c(i){var k=window.document.createElement("a");var j=window.location.href;k.href=i;k.href=k.href;return k.protocol+k.hostname+k.port}this.videoItem=f;this.serverDuration=this.videoProxy.getDurationFromItem(f);this.videoProxy.serverDuration=this.serverDuration;if(!b.Util.isNull(this.serverDuration)){var h=new b.event.VideoEvent(b.event.VideoEvent.NOTF_DURATION,this.serverDuration,true);this.dispatchEvent(h,false)}if(this.helperImage){var d=this.videoProxy.resolvePosterUrl(this.assetSpecificPosterImage,this.posterimage,this.aemmode,f,true);if(b.browser.name=="safari"){this.helperImage.removeAttribute("crossOrigin");if((c(b.Util.resolveURL(this.serverUrl,d))!=c(window.location.href))){this.helperImage.setAttribute("crossOrigin","anonymous")}}this.helperImage.src=b.Util.resolveURL(this.serverUrl,d)}this.videoProxy.setAsset(f);this.renderer.setAnimationLoop(this.render);var e=this.videoProxy.getCurrentTime();var g=new b.UserEvent(b.UserEvent.PLAY,e,true);this.dispatchEvent(g,false);this.endNotificationSent=false};b.video.Video360Player.prototype.setItem=function(d){b.Logger.log(b.Logger.INFO,"Video360Player.setItem( %0 )",d);if(this.isReq_){this.isReq_.cancelHttpReq()}if(!((d instanceof b.VideoDesc&&d.type==b.ItemDescType.VIDEO)||(d instanceof b.MediaSetDesc&&(d.type==b.ItemDescType.VIDEO_SET)||d.type==b.ItemDescType.VIDEO_GROUP))){throw new Error("Item must be a video!")}this.allowInitialUserEvent=true;this.currentAsset=d;var c=new b.event.VideoEvent(b.event.VideoEvent.NOTF_CURRENT_TIME,0,true);this.dispatchEvent(c,false);var e=new b.UserEvent(b.UserEvent.CURRENT_TIME,0,true);this.dispatchEvent(e,false);this.createViewer(d);this.asset="";if(!this.metadataReadyEventSent){var e=new b.event.StatusEvent(b.event.StatusEvent.NOTF_ASSET_METADATA_READY,true);b.Event.dispatch(this.obj,e,false);this.metadataReadyEventSent=true}};b.video.Video360Player.prototype.getVolume=function(){if(this.supportsVolumeControl()){return this.videoProxy.getVolume()}else{return 1}};b.video.Video360Player.prototype.setVolume=function(c){if(this.supportsVolumeControl()){this.videoProxy.setVolume(c);if(!this.videoProxy.muted()&&this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.UNMUTE)){var d=new b.UserEvent(b.UserEvent.UNMUTE,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(d)}if(this.videoProxy.muted()&&this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.MUTE)){var d=new b.UserEvent(b.UserEvent.MUTE,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(d)}this.checkState()}};b.video.Video360Player.prototype.getCurrentTime=function(){return this.videoProxy.getCurrentTime()};b.video.Video360Player.prototype.getLoadedPosition=function(){return this.videoProxy.getLoadedPosition()};b.video.Video360Player.prototype.getDuration=function(){if(!b.Util.isNull(this.videoProxy.getDuration())){return this.videoProxy.getDuration()}else{if(!b.Util.isNull(this.serverDuration)){return this.serverDuration}else{return undefined}}};b.video.Video360Player.prototype.getCapabilityState=function(){b.Logger.log(b.Logger.INFO,"Video360Player.getCapabilityState() = %0 ",this.videoCapabilityState);return this.videoCapabilityState};b.video.Video360Player.prototype.checkState=function(){var c=this.videoCapabilityState;this.videoCapabilityState=new b.VideoCapabilityState();if(this.videoProxy.paused()&&!this.videoProxy.ended()){this.videoCapabilityState.setCapability(b.VideoCapabilityState.PLAY);if(this.videoProxy.getCurrentTime()>0){this.videoCapabilityState.setCapability(b.VideoCapabilityState.STOP)}}if(!this.videoProxy.paused()&&!this.videoProxy.ended()){this.videoCapabilityState.setCapability(b.VideoCapabilityState.PAUSE);this.videoCapabilityState.setCapability(b.VideoCapabilityState.STOP)}this.videoProxy.muted()?this.videoCapabilityState.setCapability(b.VideoCapabilityState.UNMUTE):this.videoCapabilityState.setCapability(b.VideoCapabilityState.MUTE);if(this.videoProxy.ended()){this.videoCapabilityState.setCapability(b.VideoCapabilityState.REPLAY)}if((c==null)||(c.state!=this.videoCapabilityState.state)){this.dispatchEvent(new b.event.CapabilityStateEvent(b.event.CapabilityStateEvent.NOTF_VIDEO_CAPABILITY_STATE,this.videoCapabilityState))}};b.video.Video360Player.prototype.ended=function(){return this.videoProxy.ended()};b.video.Video360Player.prototype.play=function(){if(!this.setRequestLoaded){this.fillMethodQueue("play");return}this.activeAutoRotate(false);this.texturePosterImageLoaded=false;var c=this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.REPLAY);if(!this.videoProxy.ended()){if(!this.hasVideoTexture){this.createVideoTexture();this.updateTexture()}this.videoProxy.play();this.renderer.setAnimationLoop(this.render);var d=this.videoProxy.getCurrentTime();if(!c){var e=new b.UserEvent(b.UserEvent.PLAY,d,true);this.dispatchEvent(e)}this.endNotificationSent=false;if(c){var e=new b.UserEvent(b.UserEvent.REPLAY,d,true);this.dispatchEvent(e)}}};b.video.Video360Player.prototype.pause=function(){if(!this.setRequestLoaded){this.fillMethodQueue("pause");return}this.activeAutoRotate(false);this.videoProxy.pause();if(this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.PAUSE)){var c=new b.UserEvent(b.UserEvent.PAUSE,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(c)}};b.video.Video360Player.prototype.stop=function(){if(!this.setRequestLoaded){this.fillMethodQueue("stop");return}this.videoProxy.pause();this.videoProxy.seek(0);this.pendingStopNotification=true;this.videoQosMetric.handlePlaybackComplete()};b.video.Video360Player.prototype.togglePause=function(){if(!this.hasVideoTexture){this.createVideoTexture();this.updateTexture()}if(this.videoCapabilityState!=null){if(this.videoCapabilityState.hasCapability(b.VideoCapabilityState.PLAY)||this.videoCapabilityState.hasCapability(b.VideoCapabilityState.REPLAY)){var c=this.getDuration()-this.getCurrentTime();if(c<=1){this.seek(0)}this.play()}else{if(this.videoCapabilityState.hasCapability(b.VideoCapabilityState.PAUSE)){this.pause()}}}};b.video.Video360Player.prototype.seek=function(d){if(!this.setRequestLoaded){this.fillMethodQueue("seek",[d]);return}this.videoProxy.seek(d);var c=this.getCurrentTime();if(!b.Util.isNumber(c)){c=d}this.endNotificationSent=false};b.video.Video360Player.prototype.muted=function(){if(this.supportsVolumeControl()){return this.videoProxy.muted()}else{return false}};b.video.Video360Player.prototype.mute=function(){if(this.supportsVolumeControl()){if(this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.MUTE)){var c=new b.UserEvent(b.UserEvent.MUTE,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(c)}this.videoProxy.mute(true);this.checkState()}};b.video.Video360Player.prototype.unmute=function(){if(this.supportsVolumeControl()){if(this.videoCapabilityState&&this.videoCapabilityState.hasCapability(b.VideoCapabilityState.UNMUTE)){var c=new b.UserEvent(b.UserEvent.UNMUTE,this.videoProxy.getCurrentTime(),true);this.dispatchEvent(c)}this.videoProxy.mute(false);this.checkState()}};b.video.Video360Player.prototype.checkTimingEvents=function(){var c=this.videoProxy.getDuration();if(b.Util.isNull(c)||c==0){return}var e=b.Util.isNull(this.videoProxy.getCurrentTime())?0:this.videoProxy.getCurrentTime();e=25*Math.floor((e*4)/c);if(e!=this.curMilestone){this.curMilestone=e;var d=new b.UserEvent(b.UserEvent.MILESTONE,this.curMilestone,true);this.dispatchEvent(d,false)}};b.video.Video360Player.prototype.fillMethodQueue=function(d,c){this.methodCallQueue.push({func:d,args:c})};b.video.Video360Player.parseMovieUrl=function(d){var c=null;if(d){c=d.replace(/[\\]/g,"/");ar=c.split(/\.(mp4|f4v|flv|webm)/i);if(ar.length>1){c=ar[0]}ar=c.split(":");if(ar.length>1){c=ar[1]}ar=c.split("/");c=ar.length>1?ar[0]+"/"+ar[ar.length-1]:c}return c};b.video.Video360Player.prototype.supportsVolumeControl=function(){var c=true;if(("ipad"==b.browser.device.name)||("iphone"==b.browser.device.name)||("android"==b.browser.device.name)){c=false}return c};b.video.Video360Player.prototype.setCSS=function(e,d,c){if(this.isRestrictedCSSProperty(b.video.Video360Player.RESTRICTED_STYLES,d)){throw new Error("You cannot set "+e+" : "+d+" CSS property for this component ")}else{this.superproto.setCSS.apply(this,[e,d,c])}};b.video.Video360Player.prototype.dispose=function(){this.cleanUp();if(this.obj){if(this.obj.parentElement){this.obj.parentElement.removeChild(this.obj)}}};b.video.Video360Player.prototype.setVR=function(){this.vrRender=false;this.obj.appendChild(b.libs.three.THREE.WEBVR.createButton(this.renderer,{frameOfReferenceType:"head-model"}))};b.video.Video360Player.prototype.cleanUp=function(){window.removeEventListener("deviceorientation",this.setOrientationControls_,true);if(this.isReq_){this.isReq_.cancelHttpReq();this.isReq_=null}this.methodCallQueue.splice(0,this.methodCallQueue.length);this.helperCanvas=null;if(this.helperImage){this.helperImage.onload=null;this.helperImage.src="";this.helperImage=null}if(this.iconEffectObj){this.iconEffectObj.dispose();this.iconEffectObj=null}if(this.videoQosMetric){this.videoQosMetric.dispose()}if(this.videoProxy){this.videoProxy.dispose()}this.clearSphere();if(this.obj){b.Event.removeDOMListener(this.obj,"click",this.onClickHandler);b.Event.removeDOMListener(this.obj,"click",this.onTogglePauseHandler);b.Event.removeDOMListener(this.obj,"touchend",this.onTouchEndHandler);b.Event.removeDOMListener(this.obj,"click",this.onTouchClickHandler);this.obj.removeEventListener("keydown",this.keyDownHandler,true)}var c=document.getElementById(this.id+"_specbtn");if(c){c.parentNode.removeChild(c)}b.Util.removeTags(this.obj);this.obj.style.cssText=""};b.video.Video360Player.prototype.showWaitIcon=function(c){if(this.waitIconObj){this.waitIconObj.style.visibility=c?"inherit":"hidden"}};b.video.Video360Player.prototype.activeAutoRotate=function(c){this.autoRotate=c||false;this.control.autoRotate=this.autoRotate};b.video.Video360Player.prototype.setVRRender=function(c){throw new Error("Trying to use setVRRender on the Core class (Video360Player) is unsupported! Please refer to SDK documentation on using setVRRender.")};b.video.Video360Player.prototype.setOrientationControls=function(d){if(!d.alpha||!this.vrRender){return}this.control=new b.libs.three.THREE.DeviceOrientationControls(this.camera,true);this.control.connect();this.control.update();var c=document.getElementById(this.id+"_specbtn");if(c){c.parentNode.removeChild(c)}window.removeEventListener("deviceorientation",this.setOrientationControls_,true)};b.video.Video360Player.prototype.getPov=function(){if(this.control){return new b.PovDesc(this.control.lon,this.control.lat)}else{return null}};b.video.Video360Player.prototype.setPov=function(c){if(this.control&&c){this.control.lon=c.lon;this.control.lat=c.lat;this.autoRotatePause()}};b.video.Video360Player.prototype.autoRotatePause=function(){this.autoRotate=false;this.control.autoRotate=this.autoRotate};b.video.Video360Player.prototype.autoRotateResume=function(){this.autoRotate=true;this.control.autoRotate=this.autoRotate};b.video.Video360Player.prototype.resetQosMetric=function(){if(this.videoQosMetric){this.videoQosMetric.reset()}};b.video.Video360Player.prototype.onManifestLoadError=function(){var c=this.isStreamingPlaybackType(this.playback.type);if(!c||!this.currentAsset){return}this.videoQosMetric.dispose();this.videoProxy.dispose();this.clearSphere();this.playback.type=b.video.playbackType.PROGRESSIVE;this.videoProxy=this.resolveVideoProxy();this.create360Video();this.videoProxy.setAsset(this.currentAsset)};b.video.Video360Player.prototype.isStreamingPlaybackType=function(c){return c===b.video.playbackType.AUTO||c===b.video.playbackType.HLS||c===b.video.playbackType.DASH};b.Video360Player=b.video.Video360Player;(function a(){var f=b.Util.css.createCssRuleText;var e=b.Util.css.createCssImgUrlText;var d=b.browser&&b.browser.name=="ie"&&b.browser.version.major>=10;var c=f(".s7video360player",{"cursor":"pointer","position":"absolute","width":"400px","height":"300px","background-color":"#000000","-webkit-touch-callout":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)","touch-action":d?"none":""})+f(".s7video360player div[role='button']",{"position":"relative","z-index":"1"})+f(".s7video360player .s7iconeffect",{"width":"120px","height":"120px","-webkit-transform":"translateZ(0px)","background-repeat":"no-repeat","background-position":"center"})+f(".s7video360player .s7iconeffect[state='play']",{"background-image":e("video360playicon.png")})+f(".s7video360player .s7iconeffect[state='replay']",{"background-image":e("videoreplayicon.png")})+f(".s7video360player .s7waiticon",{"background-image":e("busyicon.gif"),"background-repeat":"no-repeat","background-position":"center","position":"absolute","width":"101px","height":"29px","left":"50%","top":"50%","margin-left":"-50px","margin-top":"-15px"})+f(".s7video360player .s7trackdeviceorientationbutton",{"position":"absolute","z-index":"999","text-align":"center","bottom":"90px","left":"calc(50% - 100px)","width":"200px","padding":"12px 6px","border":"1px solid #fff","background":"rgba(0,0,0,0.1)","color":"#fff","font":"normal 13px sans-serif","outline":"none","cursor":"pointer","user-select":"none","-moz-user-select":"-moz-none","-webkit-user-select":"none"});b.Util.css.addDefaultCSS(c,"Video360Player")})()}})(s7getCurrentNameSpace());