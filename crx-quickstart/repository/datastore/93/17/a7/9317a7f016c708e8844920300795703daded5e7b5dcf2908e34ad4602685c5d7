/*
 * ADOBE CONFIDENTIAL
 *
 * Copyright 2016 Adobe Systems Incorporated
 * All Rights Reserved.
 *
 * NOTICE:  All information contained herein is, and remains
 * the property of Adobe Systems Incorporated and its suppliers,
 * if any.  The intellectual and technical concepts contained
 * herein are proprietary to Adobe Systems Incorporated and its
 * suppliers and may be covered by U.S. and Foreign Patents,
 * patents in process, and are protected by trade secret or copyright law.
 * Dissemination of this information or reproduction of this material
 * is strictly forbidden unless prior written permission is obtained
 * from Adobe Systems Incorporated.
 */
(function (document, Granite, $, window) {
    "use strict";

    window.ManagePublication = window.ManagePublication || {};
    var ManagePublication = window.ManagePublication;
    var constants = ManagePublication.constants || {};

    var ns = constants.ns;

    var PACKAGE_SELECTOR = constants.PACKAGE_SELECTOR;
    var PACKAGE_PATH = constants.PACKAGE_PATH;

    var WIZARD_SELECTOR = constants.WIZARD_SELECTOR;
    var DESTINATION_TEXT_SELECTOR = constants.DESTINATION_TEXT_SELECTOR;
    var TABLE_SELECTOR = constants.TABLE_SELECTOR;
    var REPLICATION_TYPE_FIELD_SELECTOR = constants.REPLICATION_TYPE_FIELD_SELECTOR;
    var SCHEDULING_FIELD_SELECTOR = constants.SCHEDULING_FIELD_SELECTOR;
    var DESTINATION_FIELD_SELECTOR = constants.DESTINATION_FIELD_SELECTOR;
    var SUBMIT_BUTTON_SELECTOR = constants.SUBMIT_BUTTON_SELECTOR;
    var REFERENCES_ACTION_SELECTOR = constants.REFERENCES_ACTION_SELECTOR;

    var REPLICATION_TYPE_ACTIVATE = constants.REPLICATION_TYPE_ACTIVATE;
    var REPLICATION_TYPE_DEACTIVATE = constants.REPLICATION_TYPE_DEACTIVATE;
    var DESTINATION_PUBLISH = constants.DESTINATION_PUBLISH;
    var DESTINATION_PREVIEW = constants.DESTINATION_PREVIEW;
    var SCHEDULING_NOW = constants.SCHEDULING_NOW;
    var SCHEDULING_LATER = constants.SCHEDULING_LATER;

    var ACTION_TEXT_PREVIEW = constants.ACTION_TEXT_PREVIEW;
    var ACTION_TEXT_PUBLISH = constants.ACTION_TEXT_PUBLISH;
    var ACTION_TEXT_UNPUBLISH = constants.ACTION_TEXT_UNPUBLISH;

    var NUM_CHILDREN_CHECK = constants.NUM_CHILDREN_CHECK;
    var DEFAULT_AGENT_CLASS = constants.DEFAULT_AGENT_CLASS;
    var DEFAULT_REPLICATION_AGENT_ID = constants.DEFAULT_REPLICATION_AGENT_ID;
    var PREVIEW_REPLICATION_AGENT_ID = constants.PREVIEW_REPLICATION_AGENT_ID;
    var SCOPE_STEP_CLASS = constants.SCOPE_STEP_CLASS;
    var WORKFLOWS_STEP_CLASS = constants.WORKFLOWS_STEP_CLASS;

    var FT_TREE_ACTIVATION_PREVIEW = "ft-sites-1689";
    var FT_PUBLISH_TO_PREVIEW = "ft-sites-125";
    var shouldShowDestination = false;

    var treeURL = Granite.HTTP.externalize("/bin/wcm/siteadmin/tree.json");
    var referencesURL = Granite.HTTP.externalize("/bin/wcm/references.json");
    var previewUrlURL = Granite.HTTP.externalize('/mnt/overlay/wcm/core/content/previewUrl.json');

    var $document = $(document);
    var $window = $(window);
    var ui = $window.adaptTo("foundation-ui");
    var registry = $window.adaptTo("foundation-registry");
    var Paginator = $window.adaptTo("foundation-util-paginator");
    var messenger = $window.adaptTo("foundation-util-messenger");
    var authorizablesCache = {};
    var paginator;
    var table, wizard, form;
    var previewUrl;
    var defaultWorkflowTitle = "Publish workflow";
    var coralFieldLabel = ".coral-Form-fieldlabel";

    function fetchPreviewUrl() {
        fetch(previewUrlURL).
        then(response => response.json()).
        then(data => previewUrl=data.previewUrl);
    }

    // references management
    // list of aggregated references over all selected resources
    var AGGREGATED_REFERENCES_NAME = "refPathList";
    var references_aggregated = [];
    // list of the status of the aggregated resources
    var AGGREGATED_REFERENCES_STATUS_NAME = "refIncludeList";
    var references_status_aggregated = [];

    function fetchingReferencesError(error) {
        ui.prompt(Granite.I18n.get("Error"),
            Granite.I18n.get("An error occurred while fetching the references."),
            "error: " + error,
            [{
                text: Granite.I18n.get("Ok"),
                id: "no"
            }]
        );
    }

    ManagePublication.setScheduling = function(scheduleValue) {
        var $schedulingField = $(SCHEDULING_FIELD_SELECTOR);
        if ($schedulingField.length === 0) return;

        var radioToCheck = $schedulingField[0].querySelector("coral-radio[value=\"" + scheduleValue + "\"]");
        if (!radioToCheck) return;

        radioToCheck.checked = true;
        $schedulingField.trigger("change" + ns);
    }

    ManagePublication.toggleSchedulingLaterRadio = function(enable) {
        var laterRadio = document.querySelector("coral-radio[name=\"scheduling\"][value=\"" + SCHEDULING_LATER + "\"]");
        if (laterRadio) {
            laterRadio.disabled = !enable;
        }
    }

    ManagePublication.getRow =  function(data) {
        data.path = data.path || "";
        data.cache = data.cache || {};
        data.cache.thumbnailurl = data.cache.thumbnailurl || "";
        data.cache.title  = data.cache.title ? data.cache.title.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/&/g, "&amp;") : "";
        var timePublished = !!data.cache.isPublished ? `<foundation-time value="${data.cache.published}"></foundation-time>` : data.cache.published;
        var timePreviewed = !!data.cache.isPreviewed ? `<foundation-time value="${data.cache.previewed}"></foundation-time>` : data.cache.previewed;
        var description = data.cache.references ? data.cache.references.description : '';
        return `<tr is="coral-table-row" itemprop="item" class="foundation-collection-item" data-foundation-collection-item-id="${data.path}">
                    <td is="coral-table-cell" class="select" coral-table-rowselect>
                        <img class="foundation-collection-item-thumbnail" src="${data.cache.thumbnailurl}" alt="">
                    </td>
                    <td class="foundation-collection-item-title" is="coral-table-cell" alignment="column">
                        <span>${data.cache.title}</span><div class="foundation-layout-util-subtletext">${data.path}</div>
                    </td>
                    <td class="foundation-collection-item-modified" is="coral-table-cell" alignment="column" value="${data.cache.modifieddate}">
                        <foundation-time value="${data.cache.modified}"></foundation-time>
                        <div class="foundation-layout-util-subtletext foundation-collection-item-user-info" user-info-id="${data.cache.modifiedbyuser}">
                            ${data.cache.modifiedby}
                        </div>
                    </td>
                    <td class="foundation-collection-item-published" is="coral-table-cell" alignment="column" value="${data.cache.publisheddate}">
                        ${timePublished}
                        <div class="foundation-layout-util-subtletext foundation-collection-item-user-info" user-info-id="${data.cache.publishedbyuser}">
                            ${data.cache.publishedby}
                        </div>
                    </td>
                    <td class="foundation-collection-item-previewed" is="coral-table-cell" alignment="column" value="${data.cache.previeweddate}">
                        ${timePreviewed}
                        <div class="foundation-layout-util-subtletext foundation-collection-item-user-info" user-info-id="${data.cache.previewedbyuser}">
                            ${data.cache.previewedby}
                        </div>
                    </td>
                    <td class="foundation-collection-item-references" is="coral-table-cell" alignment="column">
                     <span> ${description} </span>
                    </td>
                  </tr>)`;
    }

    var text = Granite.I18n.get("There is no item.");
    var emptyRow = `<tr is="coral-table-row" class="empty-row">
                        <td is="coral-table-cell" colspan="6" alignment="center">  ${text}  </td>
                    </tr>`;

    // Verifies if an item is already loaded in the wizard and then returns that item
    function _getItemFromPath(wizard, resourcePath) {
        var retVal = null;
        if (wizard.childResourcePageList && wizard.childResourcePageList.length > 0) {
            for (var index = 0; index < wizard.childResourcePageList.length; index++) {
                var currentItem = wizard.childResourcePageList[index];
                if (currentItem.path === resourcePath) {
                    retVal = currentItem;
                    break;
                }
            }
        }
        return retVal;
    }

    function _removeResourcePath(wizard, resourcePath) {
        if (wizard.childResourcePageList && wizard.childResourcePageList.length > 0) {
            for (var index = 0; index < wizard.childResourcePageList.length; index++) {
                var currentItem = wizard.childResourcePageList[index];
                if (currentItem.path === resourcePath) {
                    wizard.childResourcePageList.splice(index, 1);
                    wizard.childResourcePageList.forEach(function (resource) {
                        wizard.hasReplicationRights = wizard.hasReplicationRights || resource.cache.hasReplicationRights;
                    });
                    $("input[type=hidden][name=srcPathList][data-path='" + currentItem.path + "']").remove();
                    break;
                }
            }
        }
    }

    function _appendResourcePage(wizard, resourcePath, bRefreshUI) {
        if (!wizard.childResourcePageList) {
            wizard.childResourcePageList = [];
        }
        var newItem = {};
        newItem.path = resourcePath;
        return _validateResourcePage(newItem).done(function() {
            if (newItem.valid) {
                var paginator = $(TABLE_SELECTOR).data("foundation-layout-table.internal.paginator");
                if (paginator) {
                    wizard.childResourcePageList.splice(paginator.offset, 0, newItem);
                    var table = _getTable(wizard);
                    _appendCurrentPage(wizard, table, newItem);
                    paginator.offset = table.items.getAll().length - $(table).find(".empty-row").length;
                    if (bRefreshUI) {
                        _refreshChildPageListUI(wizard);
                    }
                }
            }
        });
    }

    function _getTable(wizard) {
        var table = wizard.find(TABLE_SELECTOR);
        return (table.length > 0 ? table[0] : undefined);
    }

    function _getSelectedItems(wizard) {
        var contentTable = _getTable(wizard);
        return contentTable.selectedItems;
    }

    function _refreshChildPageListUI(wizard) {

        _updateButtonStates(wizard);

        var table = _getTable(wizard);
        var scopeStepControls = $(wizard).find(".foundation-layout-wizard2-controls > coral-panel:nth-of-type(2)");
        var nextControl = scopeStepControls.find(".foundation-wizard-control[data-foundation-wizard-control-action='next']")[0];

        if (wizard.childResourcePageList.length === 0) {
            table.items.add($(emptyRow)[0]);
            // explicitly trigger event (this can be removed once CUI-6679 is resolved)
            $(table).trigger("coral-collection:add");
            nextControl.disabled = true;
        }
        var emptRow = $(table).find(".empty-row");
        if (wizard.childResourcePageList.length > 0 && emptRow.length > 0) {
            table.items.remove(emptRow[0]);
            nextControl.disabled = false;
        }
    }

    function disableCheckbox(selector) {
        var check = $(selector)[0];
        if (check !== undefined) {
            check.checked = false;
            check.disabled = true;
            $(check).trigger("change" + ns);
        }
    }

    ManagePublication._shouldUseTreeActivation = function() {

        var activationDate = form[0].elements.activationDate;
        var datePickerElem = activationDate.parentElement;
        var isSchedulingLater = !datePickerElem.disabled;
        var isReplicationToPreview = wizard.replicationAgent === PREVIEW_REPLICATION_AGENT_ID;

        // Do not use Tree Activation WF if replicationType is not 'Activate' or destination is not publish and preview
        if (wizard.replicationType !== REPLICATION_TYPE_ACTIVATE || (wizard.destination !== DESTINATION_PUBLISH && wizard.destination !== DESTINATION_PREVIEW)) {
            return false;
        }

        // Do use tree activation workflow if needed feature toggles are enabled.
        if (isReplicationToPreview) {
            return Granite.Toggles.isEnabled(FT_TREE_ACTIVATION_PREVIEW);
        }
        return true;
    }

    ManagePublication._updateWorkflowsInfo = function() {
        if (wizard.requestMultiResourceSupport !== undefined && !wizard.requestMultiResourceSupport) {
            disableCheckbox(".cq-sites-startbulkworkflows-keeppackage-request");
        }

        var useTreeActivation = ManagePublication._shouldUseTreeActivation();
        var isWizardScheduleOrUseTreeActivation = wizard.schedule || useTreeActivation;
        var scheduleMultiResourceSupport = useTreeActivation ? wizard.scheduleTreeMultiResourceSupport : wizard.scheduleMultiResourceSupport;

        if (scheduleMultiResourceSupport !== undefined && !scheduleMultiResourceSupport) {
            disableCheckbox(".cq-sites-startbulkworkflows-keeppackage-schedule");
        }

        var directPublishResNo = 0;
        var requestPublishResNo = 0;
        var schedulePublishResNo = 0;
        wizard.childResourcePageList.forEach(function (resource) {
            if (resource.cache.hasReplicationRights && !wizard.schedule) {
                directPublishResNo += 1;
            }
            if (!resource.cache.hasReplicationRights) {
                requestPublishResNo +=1;
            } else if (wizard.schedule) {
                schedulePublishResNo += 1;
            }
        });

        displayScheduleSection(schedulePublishResNo, useTreeActivation);

        var cmd = $(REPLICATION_TYPE_FIELD_SELECTOR).val();
        var action = cmd === REPLICATION_TYPE_ACTIVATE ? "published" : "unpublished";

        displayDirectSection(action, directPublishResNo);
        displayRequestSection(requestPublishResNo);

        ManagePublication.setSubmitButtonLabel({
            destination: wizard.destination,
            replicationType: cmd,
            hasReplicationRights: wizard.hasReplicationRights,
            isScheduled: wizard.schedule
        });
    }

    function displayScheduleSection(schedulePublishResNo, useTreeActivation){
        var scheduleSection = $(".schedule-publication-info");
        if (!wizard.schedule || schedulePublishResNo === 0) {
            scheduleSection.hide();
        } else {
            scheduleSection.show();
            var scheduleWorkflowTitle = useTreeActivation ? wizard.scheduleTreeWorkflowTitle : wizard.scheduleWorkflowTitle;
            scheduleSection.find(coralFieldLabel).first().html(Granite.I18n.get("{0} resource(s) will run through the workflow <b>{1}</b>.", [schedulePublishResNo, scheduleWorkflowTitle]));
        }
    }

    function displayDirectSection(action, directPublishResNo){
        var directSection = $(".direct-publication-info");
        if (directPublishResNo > 0) {
            directSection.show();
            directSection.find(coralFieldLabel).html(Granite.I18n.get("{0} resource(s) will be {1} directly.", [directPublishResNo, action]));
        } else {
            directSection.hide();
        }
    }

    function displayRequestSection(requestPublishResNo){
        var requestSection = $(".request-publication-info");
        if( requestPublishResNo > 0) {
            requestSection.show();
            requestSection.find(coralFieldLabel).first().html(Granite.I18n.get("{0} resource(s) will run through the workflow <b>{1}</b>.", [requestPublishResNo, wizard.requestWorkflowTitle]));
        } else {
            requestSection.hide();
        }
    }

    function _validateResourcePage(currentItem) {
        var deferred = $.Deferred();
        //first find if we have all information about this item
        if (!currentItem.info && !currentItem.cache) {
            var url = Granite.HTTP.externalize(currentItem.path + "/jcr:content.json", true);
            currentItem.info = Granite.HTTP.eval(url);
            if (!currentItem.info) {
                url = Granite.HTTP.externalize(currentItem.path + ".json", true);
                currentItem.info = Granite.HTTP.eval(url);
            }
        }
        currentItem.valid = !!currentItem.info;
        // Use case pages without title
        if (currentItem.valid && !currentItem.info["jcr:title"]) {
            currentItem.info["jcr:title"] = currentItem.path.substring(currentItem.path.lastIndexOf("/") + 1, currentItem.path.length);
        }
        if (currentItem.valid || currentItem.cache) {
            //process more data now
            if (!currentItem.cache) {
                currentItem.cache = {};
                currentItem.cache.title = currentItem.info["jcr:title"];
                var publishedInfo = _getPublishedInfo(currentItem, false);
                var previewedInfo = _getPublishedInfo(currentItem, true);
                var modifiedInfo = _getModifiedInfo(currentItem);
                currentItem.cache.isPublished = publishedInfo.isPublished;
                currentItem.cache.published = publishedInfo.state;
                currentItem.cache.publisheddate = publishedInfo.date;
                currentItem.cache.publishedby = publishedInfo.userName;
                currentItem.cache.publishedbyuser = publishedInfo.userId;
                currentItem.cache.isPreviewed = previewedInfo.isPublished;
                currentItem.cache.previewed = previewedInfo.state;
                currentItem.cache.previeweddate = previewedInfo.date;
                currentItem.cache.previewedby = previewedInfo.userName;
                currentItem.cache.previewedbyuser = previewedInfo.userId;
                currentItem.cache.modifieddate = modifiedInfo.date;
                currentItem.cache.modifiedby = modifiedInfo.userName;
                currentItem.cache.modified = modifiedInfo.state;
                currentItem.cache.modifiedbyuser = modifiedInfo.userId;
                currentItem.cache.thumbnailurl = Granite.HTTP.externalize(currentItem.path + ".thumb.48.48.png?ck=" + modifiedInfo.date);
                _checkReplicationPriviledge(currentItem);
            }

            if (!currentItem.cache.references) {
                // get references
                currentItem.cache.references = {};
                currentItem.cache.references.all = {};
                currentItem.cache.references.total = 0;

                _getReferences([currentItem.path]).success(function (json) {
                    var refs = [];
                    for (var i = 0; i < json.assets.length; i++) {
                        refs.push(json.assets[i].path);
                    }

                    currentItem.cache.references = {};
                    currentItem.cache.references.all = refs;
                    currentItem.cache.references.total = refs.length;
                    currentItem.cache.references.description = ManagePublication._getReferencesInfo(currentItem);
                    deferred.resolve();
                }).fail(function() {
                  deferred.reject();
                });
              }
            else {
              deferred.resolve();
            }
        } else {
            deferred.reject();
        }

        return deferred.promise();
    }

    function _checkReplicationPriviledge(item) {
        var servletUrl = Granite.HTTP.externalize(item.path + ".permissions.json");
        var hasRights = false;
        $.ajax({
            url: servletUrl,
            type: "GET",
            dataType: "json",
            data: {
                "privileges": "crx:replicate"
            }
        }).done(function (responseJson) {

                if (responseJson.hasOwnProperty("crx:replicate")) {
                    hasRights = responseJson["crx:replicate"] || false;
                }
                item.cache.hasReplicationRights = hasRights;
                wizard.hasReplicationRights = wizard.hasReplicationRights && hasRights;

                _updateWizardSteps(wizard);
                ManagePublication._updateWorkflowsInfo();
            }
        );
    }

    ManagePublication.hasReplicationRights = function() {
        return wizard.hasReplicationRights;
    }

    function _getPublishedInfo(item, isPreview) {
        var nnSuffix = (isPreview ? "_preview" : "");
        var replicatedDate = item.info["cq:lastReplicated" + nnSuffix];
        var lastReplicationAction = item.info["cq:lastReplicationAction" + nnSuffix];
        var state = "";
        var userId = item.info["cq:lastReplicatedBy" + nnSuffix];
        var userName = "";
        var date = "";
        var isPublished = true;

        if (replicatedDate) {
            var replDate = new Date(replicatedDate);
            state = replDate.toISOString();
            date = replDate.getTime();
        }
        if (lastReplicationAction !== REPLICATION_TYPE_ACTIVATE) {
            isPublished = false;
            if (isPreview) {
                state = Granite.I18n.get("Not previewed");
            }
            else {
                state = Granite.I18n.get("Not published");
            }
            userId = "";
        } else {
            if (userId) {
                userName = _resolveUserNameById(userId);
            }
        }
        return {
            isPublished: isPublished,
            state: state,
            userName: userName,
            userId: userId || "",
            date: date
        };
    }

    function _getModifiedInfo(item) {
        var lastModifiedDate = item.info["cq:lastModified"];
        var userId = item.info["cq:lastModifiedBy"];
        if(!lastModifiedDate) {
            lastModifiedDate = item.info["jcr:lastModified"];
        }
        if(!userId) {
            userId = item.info["jcr:lastModifiedBy"];
        }
        var userName = "";
        var state = "";
        var date = "";
        if (lastModifiedDate) {
            var lastModDate = new Date(lastModifiedDate);
            state = lastModDate.toISOString();
            date = lastModDate.getTime();
        }
        if (userId) {
            userName = _resolveUserNameById(userId);
        }
        return {
            state: state,
            userName: userName,
            userId: userId,
            date: date
        };
    }

    function _resolveUserNameById(userId) {
        var servletUrl = Granite.HTTP.externalize('/libs/granite/security/search/profile.userproperties.json?authId=' + userId + '&path=');
        var userName = "";
        if (!authorizablesCache.hasOwnProperty(userId)) {
            authorizablesCache[userId] = "";
            $.ajax({
                url: servletUrl,
                type: "GET",
                dataType: "json",
                success: function (responseJson) {
                    authorizablesCache[userId] = userName;
                    var userData = {};
                    if (responseJson.hasOwnProperty("authorizables") && responseJson.authorizables.length) {
                        userData = responseJson.authorizables[0];
                        if (userData.hasOwnProperty("name")) {
                            userName = userData.name;
                            authorizablesCache[userId] = userName;
                            _updateSourceUserInfos();
                        }
                    }
                }
            });
        } else {
            userName = authorizablesCache[userId];
        }
        return userName;
    }

    function _updateSourceUserInfos() {
        var form = _getFormElement();
        var wizard = _getWizardFromForm(form);
        var table = _getTable(wizard);
        $(table).find('.foundation-collection-item-user-info[user-info-id]').each(function () {
            var userId = $(this).attr("user-info-id");
            var userName = authorizablesCache[userId];
            if (userName) {
                $(this).text(userName);
                $(this).removeAttr("user-info-id");
            }
        });
    }

    function _appendCurrentPage(wizard, table, currentItem) {
        table.variant = Coral.Table.variant.LIST;
        table.multiple = true;
        table.selectable = true;
        var $table_row = $(ManagePublication.getRow(currentItem));

        table.items.add($table_row[0]);
        _appendHiddenField(wizard, 'srcPathList', currentItem.path, currentItem.path);
        // explicitly trigger event (this can be removed once CUI-6679 is resolved)
        $(table).trigger("coral-collection:add");
    }

    ManagePublication._updateIncludeChildrenParams = function(wizard, params) {
        params = params || {};
        var onlyDirectChildren = params.onlydirect || "false";
        var includeChildren = params.includeChildren || "false";
        var filterArr = [];
        if (params.onlymodified === "true") {
            filterArr.push("onlyModified");
        }
        if (params.reactivate === "true") {
            filterArr.push("onlyActivated");
        }
        var filters = filterArr.join("|");
        ManagePublication._updateHiddenField(wizard, "onlyDirectChildren", "", onlyDirectChildren);
        ManagePublication._updateHiddenField(wizard, "includeChildren", "", includeChildren);
        ManagePublication._updateHiddenField(wizard, "filters", "", filters);
    }

    function _updateItemIncludeSubPages(wizard, resources) {
        //Add child resources in the table
        if (resources.length === 0) {
            return;
        }
        var bAdded = false;
        var bRootPath = false;
        var paginator = $(_getTable(wizard)).data("foundation-layout-table.internal.paginator");
        var initialOffset = paginator.offset;

        // get the misisng items to update the references
        var missingItems = [];
        var processedResources = [];
        resources.forEach(function (currentItem) {
            var path = currentItem.path;
            if (path !== '/content') {
                var itemFromPath = _getItemFromPath(wizard, path);
                // if item is not already in the wizard's collection, add it to our to do arrays
                if (itemFromPath === null) {
                    missingItems.push(path);
                    processedResources.push(currentItem);
                }
            }
        });

        var onReferencesUpdate = function() {
          var promisses = [];
          processedResources.forEach(function (currentItem, index) {
              var newItem = _getItemFromPath(wizard, currentItem.path);
              if (newItem === null) {
                  if (currentItem.path !== '/content') {
                    wizard.childResourcePageList.push(currentItem);
                    if (index < paginator.limit) {
                          var promise = _validateResourcePage(currentItem).done(function () {
                            var table = _getTable(wizard);
                            if (table.items.getAll().length - $(table).find(".empty-row").length <= (initialOffset + paginator.limit)) {
                                // append the child to the list of visible items in the table
                                _appendCurrentPage(wizard, _getTable(wizard), currentItem);
                                paginator.offset = table.items.getAll().length - $(table).find(".empty-row").length;
                            }
                        });
                        promisses.push(promise);
                      } else {
                        _appendHiddenField(wizard, 'srcPathList', currentItem.path, currentItem.path);
                      }
                      bAdded = true;
                    } else {
                      bRootPath = true;
                  }
              }
          });
          $.when.apply($, promisses).fail(function() {
              ui.prompt(Granite.I18n.get("Error"),
                  Granite.I18n.get("Selected resources are not valid."),
                  "error",
                  [{
                      text: Granite.I18n.get("Ok"),
                      id: "no"
                  }]
              );
          }).always(function() {
              ui.clearWait();
          });
          if (bAdded) {
              _refreshChildPageListUI(wizard);
          } else if (!bRootPath) {
              ui.prompt(Granite.I18n.get("Error"),
                  Granite.I18n.get("Selected page already exist in the list."),
                  "error",
                  [{
                      text: Granite.I18n.get("Ok"),
                      id: "no"
                  }]
              );
          }
        };
        // update the references in the aggregated list
        _manageReferences('update', {'path': missingItems })
          .done(onReferencesUpdate)
          .fail(fetchingReferencesError)
          .always(function() {
            ui.clearWait();
          });
    }

    /**
     * Get the information regarding references for the user
     * @param currentItem
     * @returns {*} the info as text
     * @private
     */
    ManagePublication._getReferencesInfo = function(currentItem) {
        var total = currentItem.cache.references.total, selected = 0;
        var description = Granite.I18n.get("all");

        var references = currentItem.cache.references.all;
        for (var i = 0; i < references.length; i++) {
            var reference = references[i];
            if (_referenceIsSelected(reference)) {
                selected++;
            }
        }

        if (total === 0) {
            description = Granite.I18n.get("No references to publish");
        } else if (selected === 0) {
            description = Granite.I18n.get("Publishing none of {0} reference(s)", total);
        } else if (total > selected) {
            description = Granite.I18n.get("Publishing {0} of {1} reference(s)", [selected, total]);
        }

        return description;
    }

    ManagePublication._updateReferenceInfo = function(currentItem) {
        var referencesColumn = wizard.find("[data-foundation-collection-item-id='" + currentItem.path + "']" +
            " .foundation-collection-item-references");
        if (referencesColumn.length) {
            referencesColumn.text(ManagePublication._getReferencesInfo(currentItem));
        }
    }

    /**
     * Update the references in the table
     * @param wizard
     * @param event
     * @private
     */
    function _updateItemReferences(wizard, event) {
        var selected = event.selectedReferences,
            unselected = event.unselectedReferences;

        // update the status of the aggregated references
        // selected references
        for (var index = 0; index < selected.length; index++) {
            var selectReference = selected[index];
            _updateReference(selectReference, true);
        }
        // unselected references
        for (var index2 = 0; index2 < unselected.length; index2++) {
            var unselectReference = unselected[index2];
            _updateReference(unselectReference, false);
        }

        // update the hidden fields holding the serialized information of the aggregated references
        _updateReferencesHiddenFields();

        // after selecting / unselecting a reference, the information regarding references for the user has to be
        // updated
        // update the reference info for all elements in the table
        var items = wizard.childResourcePageList;
        items.forEach(function (currentItem) {
            ManagePublication._updateReferenceInfo(currentItem);
        });
    }

    /**
     * Manage the references
     *
     * @param action 'update', 'remove'
     * @param params data for the references POST
     * @private
     */
    function _manageReferences(action, params) {

        var deferred = $.Deferred();

        action = (action || 'update');
        if (!params) {
            var paths = [];
            for (var i = 0; i < wizard.childResourcePageList.length; i++) {
                paths.push(wizard.childResourcePageList[i].path);
            }
            params = {'path': paths};
        }

        if (!params.path) {
          deferred.resolve();
        } else {
          _getReferences(params.path).success(function (json) {
            if (json.assets) {
                var refs = [];
                var status = [];

                for (var i = 0; i < json.assets.length; i++) {
                    var path = json.assets[i].path;
                    if (!path) continue;

                    if (action === 'remove') {
                        // rebuild the references but preserve the status

                        // get the current index
                        var oldIdx = _getReferenceIndex(path);

                        // copy reference to new object
                        var newIdx = refs.length;
                        refs[newIdx] = references_aggregated[oldIdx];
                        status[newIdx] = references_status_aggregated[oldIdx];
                    } else if (action === 'update') {
                        // when adding a new reference, reference is selected by default
                        _updateReference(path, true, true);
                    }
                }
                if (action === 'remove') {
                    references_aggregated = refs;
                    references_status_aggregated = status;
                }

                // take care of the hidden fields
                _updateReferencesHiddenFields();
                // take care of the references information in the table
                var items = wizard.childResourcePageList;
                items.forEach(function (currentItem) {
                    ManagePublication._updateReferenceInfo(currentItem);
                });
            }
            deferred.resolve(json);
          }).fail(function(error) {
              deferred.reject(error);
          });
        }

        return deferred.promise();
    }

    /**
     * Update the status of a reference
     * @param path reference path
     * @param isSelectedByDefault default value for selected status
     * @param preserveStatus when updating, preserve the status of the reference
     * @returns {*}
     * @private
     */
    function _updateReference(path, isSelectedByDefault, preserveStatus) {
        var idx = _getReferenceIndex(path);

        // update or add a new reference to the aggregated list
        if (preserveStatus) {
            if (idx > -1) {
                // reference is already registered, nothing to do here, no rewriting of the reference status
                return idx;
            }
        }

        if (idx === -1) idx = references_aggregated.length;

        references_aggregated[idx] = path;
        references_status_aggregated[idx] = isSelectedByDefault;

        return idx;
    }

    /**
     * Add / update the hidden fields for the reference management
     * @private
     */
    function _updateReferencesHiddenFields() {
        // update / add the hidden fields
        var wizard_form = $(wizard[0]);
        // aggregated references
        ManagePublication._updateHiddenField(wizard, AGGREGATED_REFERENCES_NAME, "", JSON.stringify(references_aggregated));
        // status of the aggregated references
        ManagePublication._updateHiddenField(wizard, AGGREGATED_REFERENCES_STATUS_NAME, "", JSON.stringify(references_status_aggregated));
    }

    /**
     * check if a reference is selected
     * a reference is selected by default
     * @param path reference path
     * @returns {boolean|*} reference is selected
     * @private
     */
    function _referenceIsSelected(path) {
        var idx = _getReferenceIndex(path);
        // if reference is already registered, check the status
        // otherwise return true by default
        return ((idx > -1 && references_status_aggregated[idx]) || (idx === -1));
    }

    /**
     * get the index of the reference
     * @param path
     * @returns {*}
     * @private
     */
    function _getReferenceIndex(path) {
        var idx = $.inArray(path, references_aggregated);
        if (idx > -1) {
            return idx;
        }
        return -1;
    }

    /**
     * Get the references from the server
     * @param paths array of paths to get references for
     * @returns {*}
     * @private
     */
    function _getReferences(paths) {
        if (!wizard.referencesUrl) {
            wizard.referencesUrl = form.data("referencesurl");
        }

        return $.ajax(Granite.URITemplate.expand(wizard.referencesUrl), {
            "type": "POST",
            "cache": false,
            "dataType": "json",
            // use data attribute to avoid HTTP Error 414: The request URL is too long
            // in case there are a lot of pages to be checked for references and would exceed the max URL length of 2000
            "data": {
                path: paths,
                agentId: wizard.replicationAgent
            }
        });
    }

    ManagePublication._updateHiddenField = function(wizard, name, pathInfo, value) {
        var wizard_form = $(wizard[0]);
        // if the hidden field already exists, update value, otherwise append new hidden field.
        var $input = wizard_form.find("input[type='hidden'][name='" + name +"']");
        if ($input.length) {
            $input.val(value);
            $input.attr("data-path", pathInfo);
        } else {
            _appendHiddenField(wizard, name, pathInfo, value);
        }
    }

    function escapeSelector(selector) {
        var rcssescape = /([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g; //eslint-disable-line no-control-regex
        var fcssescape = function(ch, asCodePoint) {
            var escapelength = 16;
            var charString = ch.charCodeAt(ch.length - 1).toString(escapelength);
            if (asCodePoint) {
                // U+0000 NULL becomes U+FFFD REPLACEMENT CHARACTER
                if (ch === "\0") {
                    return "\uFFFD";
                }
                // Control characters and (dependent upon position) numbers get escaped as code points
                return `${ch.slice(0, -1)}\\${charString} `;
            }
            // Other potentially-special ASCII characters get backslash-escaped
            return "\\" + ch;
        };
        return selector.replace(rcssescape, fcssescape);
    }

    function _appendHiddenField(wizard, name, pathInfo, value) {
        var wizard_form = $(wizard[0]);
        var escapevalue = escapeSelector(JSON.stringify(value));
        // check if the hidden field already exists with given value
        if (wizard_form.find(`input[type=hidden][name= ${name}][value=
            ${escapevalue}]`).length > 0) {
                return;
        }
        var $hiddenField = $("<input type='hidden'/>").attr("name", name);
        wizard_form.append($hiddenField);
        $hiddenField.attr('data-path', pathInfo);
        if (value !== undefined) {
            $hiddenField.attr("value", value);
        }
    }

    function _updateWizardSteps(wizard) {
        var workflowsStep = $(".cq-common-admin-publication-workflows");
        //var isWizardScheduleOrUseTreeActivation = wizard.schedule || wizard.useTreeActivation;
        if (workflowsStep.length > 0 && !wizard.workflowsStepDetached && (wizard.hasReplicationRights && !wizard.schedule)) {
            ManagePublication.removeWorkflowsStep(wizard, workflowsStep);
            wizard.workflowsStepDetached = true;
        } else if (wizard.workflowsStepDetached && (!wizard.hasReplicationRights || wizard.schedule)) {
            ManagePublication.appendWorkflowsStep(wizard, wizard.workflowsStep);
            wizard.workflowsStepDetached = false;
        }
    }

    function _updateButtonStates(wizard) {
        $(_getTable(wizard)).trigger("foundation-selections-change");
        $(REPLICATION_TYPE_FIELD_SELECTOR).trigger("change" + ns);
        $(SCHEDULING_FIELD_SELECTOR).trigger("change" + ns);
        $(DESTINATION_FIELD_SELECTOR).trigger("change" + ns);
    }

    function _handleDeleteBtnClick(wizard) {
        var selectedItems = _getSelectedItems(wizard);
        if (selectedItems != null && selectedItems.length > 0) {
            ui.wait();
            var selectedCount = selectedItems.length;
            for (var index = 0; index < selectedCount; index++) {
                var currentItem = $(selectedItems[index]);
                _removeResourcePath(wizard, currentItem.data('foundationCollectionItemId'));
                //remove selected
                _getTable(wizard).items.remove(currentItem[0]);
            }

            var onReferencesUpdate = function() {
                //paginate
                var paginator = $(_getTable(wizard)).data("foundation-layout-table.internal.paginator");
                var hasMore = paginator.hasNext;
                if (hasMore === undefined) {
                    hasMore = selectedCount.length >= (paginator.offset + paginator.limit);
                }

                if (hasMore && table.items.getAll().length - $(table).find(".empty-row").length <= 0) {
                    paginator.restart(paginator.offset, hasMore);
                }

                _refreshChildPageListUI(wizard);
                _updateWizardSteps(wizard);
                ManagePublication._updateWorkflowsInfo();
            };

            // recreate aggregated references, but keep the status
            _manageReferences('remove')
                .done(onReferencesUpdate)
                .fail(fetchingReferencesError)
                .always(function() {
                    ui.clearWait();
                });
        }
    }

    function _parseUrlParams() {
        var search_string = location.search;

        function _parse_values_internal(params, pairs) {
            if(!pairs || pairs.length === 0) {
                return {};
            }
            var pair = pairs[0];
            var parts = pair.split('=');
            var key = decodeURIComponent(parts[0]);
            var value = decodeURIComponent(parts.slice(1).join('='));

            // Handle multiple parameters of the same name
            if (typeof params[key] === "undefined") {
                params[key] = value;
            } else {
                params[key] = [].concat(params[key], value);
            }

            return pairs.length === 1 ? params : _parse_values_internal(params, pairs.slice(1));
        }

        return search_string.length === 0 ? {} : _parse_values_internal({}, search_string.substr(1).split('&'));
    }

    /**
     * @returns {jQuery}
     */
    function _getFormElement() {
        return $(".cq-sites-managepublication-form");
    }

    /**
     * @param {jQuery} $form
     * @returns {jQuery}
     */
    function _getWizardFromForm($form) {
        return $form.find(WIZARD_SELECTOR);
    }

    function handlePagination(wizard, collection, config, paginator) {
        if (collection[0]) {
            var paginate = function (wizard, scrollContainer, paginator) {

                paginator = new Paginator({
                    el: scrollContainer[0],
                    limit: config.limit || 20,
                    wait: function() {
                        ui.wait();
                        return {
                            clear: function () {
                                ui.clearWait();
                            }
                        };
                    },
                    resolveURL: function () {
                        return "";
                    },
                    processResponse: function () {
                        ui.wait();
                        var deferred = $.Deferred();
                        var allDeferreds = [];
                        var items = wizard.childResourcePageList.slice(this.offset, this.offset + this.limit);
                        items.forEach(function (currentItem) {
                            var defValidation = _validateResourcePage(currentItem);
                            defValidation.done(function() {
                              _appendCurrentPage(wizard, _getTable(wizard), currentItem);
                            });
                            allDeferreds.push(defValidation);
                        });

                        $.when.apply($, allDeferreds).then(function() {
                          ui.clearWait();
                          var hasMore = (paginator.offset + paginator.limit) <= wizard.childResourcePageList.length;
                          deferred.resolve({
                              length: items.length,
                              hasNext: hasMore
                          });
                        });

                        return deferred.promise();
                    }
                });

                collection.data("foundation-layout-table.internal.paginator", paginator);

                Coral.commons.ready(collection[0], function() {
                    var offset = collection.find(".foundation-collection-item").length;
                    paginator.start(offset);
                });
            };

            var scrollContainer = collection.children("[coral-table-scroll]");

            if (scrollContainer.length) {
                paginate(wizard, scrollContainer, paginator);
            } else {
                requestAnimationFrame(function () {
                    paginate(wizard, collection.children("[coral-table-scroll]"), paginator);
                });
            }
        }

        return function () {
            if (paginator) {
                paginator.destroy();
                collection.removeData("foundation-layout-table.internal.paginator");
                collection.removeData("foundation-layout-table.internal.paginator.sort");
            }
        };
    }

    /**
     * Returns the promise of the total number of resources that are referencing the given paths.
     */
    ManagePublication.countReferences = function(paths) {
        return $.ajax({
            url: referencesURL,
            data: {
                path: paths,
                predicate: "wcmcontent"
            },
            "type": "POST",
            cache: false,
            dataType: "json"
        }).then(function(json) {
            if (!json.pages) {
                return 0;
            }
            return json.pages.reduce(function(memo, value) {
                if (value.published && (value.isPage === true || value.isPage === "true") && value.path !== value.srcPath) {
                    return memo + 1;
                }
                return memo;
            }, 0);
        });
    }

    /**
     * Returns the promise of the total count of the descendants of the given paths.
     *
     * The promise is rejected when both the total is "0" and there is an error.
     * i.e. when we are not sure if there is at least a descendant or not.
     */
    ManagePublication.countChildren = function(paths) {
        var total = 0;

        var promises = paths.map(function(path) {
            return $.ajax({
                url: treeURL,
                data: {
                    path: path,
                    ncc: NUM_CHILDREN_CHECK
                },
                cache: false,
                dataType: "json"
            }).then(function(children) {
                total += children.length;

                children.forEach(function(child) {
                    if (!child.leaf) {
                        total += child.sub;
                    }
                });

                return true;
            }, function() {
                return $.when(false);
            });
        });

        return $.when.apply(null, promises).then(function() {
            if (total > 0) {
                return total;
            }

            var allOK = Array.prototype.every.call(arguments, function(status) {
                return status;
            });

            if (allOK) {
                return total;
            }

            return $.Deferred().reject().promise();
        });
    }

    function pushSelectedReferences(target) {
        if (Array.isArray(target)) {
            for (var i = 0; i < references_aggregated.length; i++) {
                if (_referenceIsSelected(references_aggregated[i])) {
                    target.push(references_aggregated[i]);
                }
            }
        }
    }

    ManagePublication.manageReplicationAction = function(replicationType, destination, items) {
        //Unpublish warning when page is referenced from somewhere else
        //or it has published children
        if (replicationType === REPLICATION_TYPE_DEACTIVATE) {
            //check for references and children of the selected paths
            var countChildrenPromise = ManagePublication.countChildren(items);
            var countRefsPromise = ManagePublication.countReferences(items);

            countChildrenPromise.fail(function() {
                ui.clearWait();

                var title = Granite.I18n.get("Error");
                var message = Granite.I18n.get("Failed to retrieve child items for selected items.");
                ui.alert(title, message, "error");
            });

            countRefsPromise.fail(function() {
                ui.clearWait();

                var title = Granite.I18n.get("Error");
                var message = Granite.I18n.get("Failed to retrieve references for selected items.");
                ui.alert(title, message, "error");
            });

            $.when(countChildrenPromise, countRefsPromise).then(function(countChildren, countRefs) {
                if (countRefs === 0 && countChildren === 0) {
                    ManagePublication.startReplication(items);
                    return;
                }

                ui.clearWait();

                if (countChildren > NUM_CHILDREN_CHECK) {
                    countChildren = NUM_CHILDREN_CHECK + "+";
                }

                var messageRefs = countRefs === 0 ? "" : Granite.I18n.get("Selected items are referenced by {0} item(s).", countRefs);
                var messageChildren  = countChildren === 0 ? "" : Granite.I18n.get("Upon unpublishing, other {0} child item(s) will get unpublished.", countChildren);
                var message = messageRefs + " <br> " + messageChildren;

                ui.prompt(Granite.I18n.get("Unpublish"), message, "notice", [{
                    text: Granite.I18n.get("Cancel")
                }, {
                    text: Granite.I18n.get("Continue"),
                    warning: true,
                    handler: function() {
                        ui.wait();
                        ManagePublication.startReplication(items);
                    }
                }]);
            });
        } else {
            ManagePublication.startReplication(items);
        }
    }

    ManagePublication.startReplication = function(mainItems) {
        let items = mainItems.slice();
        var deferreds = [];

        var formActivationCmd = form[0].elements.activationCommand.value;
        var encodedFormActivationCmd = encodeURI(formActivationCmd);

        // check for references to publish
        var referencesToPublish = [];
        if (formActivationCmd === REPLICATION_TYPE_ACTIVATE) {
            pushSelectedReferences(referencesToPublish);
        }

        // copy root items to new array, before concatenating references to items.
        var contentRootPathsArr = items.slice();
        var contentRootPaths = JSON.stringify({
            contentRootPaths: contentRootPathsArr
        });

        // add the references before the items so that references are replicated first
        items = referencesToPublish.concat(items);

        if (items.length > 0) {
            var url = null;
            var settings = null;

            var datepicker = form[0].elements.activationDate.parentElement;
            //check if the activation date is enabled and if the value is filled in
            var absTime = (!datepicker.disabled && datepicker.valueAsDate !== null) ? datepicker.valueAsDate.getTime() : new Date().getTime();

            var onlyDirectChildren = form[0].elements.onlyDirectChildren ? form[0].elements.onlyDirectChildren.value : "";
            var includeChildren = form[0].elements.includeChildren ? form[0].elements.includeChildren.value : "";
            var filters = form[0].elements.filters ? form[0].elements.filters.value : "";

            var useTreeActivation = ManagePublication._shouldUseTreeActivation();
            var isWizardScheduleOrUseTreeActivation = wizard.schedule || useTreeActivation;
            var scheduleWorkflowModel = useTreeActivation ? wizard.scheduleTreeActivationWorkflow : wizard.scheduleActivationWorkflow;
            var scheduleMultiResourceSupport = useTreeActivation ? wizard.scheduleTreeMultiResourceSupport : wizard.scheduleMultiResourceSupport;

            //hide workflow step by default in tree activation workflow for "Now" use case
            var workflowTitle = form[0].elements.scheduleWorkflowTitle !== undefined ? form[0].elements.scheduleWorkflowTitle.value : defaultWorkflowTitle;
            var packageTitle = form[0].elements.schedulePackageTitle !== undefined ? form[0].elements.schedulePackageTitle.value : "";

            if (wizard.hasReplicationRights) {
                if (isWizardScheduleOrUseTreeActivation) {
                    //schedule activation
                    if (scheduleMultiResourceSupport && items.length > 1) {
                        url = Granite.HTTP.externalize(wizard.workflowUrl + PACKAGE_SELECTOR);
                        settings = {
                            "type": form.attr("method") || "POST",
                            "data": {
                                "_charset_": "utf_8",
                                "workflowModel": scheduleWorkflowModel,
                                "absoluteTime": absTime,
                                "workflowTitle": workflowTitle,
                                "packageTitle": packageTitle,
                                "workflowPackagesPath" : PACKAGE_PATH,
                                "srcPathList": items,
                                "contentRootPaths": contentRootPaths,
                                "onlyDirectChildren": onlyDirectChildren,
                                "includeChildren": includeChildren,
                                "filters": filters,
                                "agentId": wizard.replicationAgent
                            }
                        };
                    } else {
                        url = Granite.HTTP.externalize(wizard.workflowUrl);
                        settings = {
                            "type": form.attr("method") || "POST",
                            "data": {
                                "_charset_": "UTF-8",
                                "model": scheduleWorkflowModel,
                                "absoluteTime": absTime,
                                "workflowTitle": workflowTitle,
                                "payload": items,
                                "contentRootPaths": contentRootPaths,
                                "onlyDirectChildren": onlyDirectChildren,
                                "includeChildren": includeChildren,
                                "filters": filters,
                                "payloadType": "JCR_PATH",
                                "agentId": wizard.replicationAgent
                            }
                        };
                    }
                } else {
                    //publish now
                    url = Granite.HTTP.externalize(wizard.replicationUrl);
                    settings = {
                        "type": form.attr("method") || "POST",
                        "data": {
                            "_charset_": "utf-8",
                            "cmd": encodedFormActivationCmd,
                            "path": items,
                            "agentId": wizard.replicationAgent
                        }
                    };
                }
                deferreds.push($.ajax(url, settings));
            } else {
                //request for activation
                var requestItems = [];
                items = [];
                wizard.childResourcePageList.forEach(function (resource) {
                    if (resource.path) {
                        if (resource.cache.hasReplicationRights) {
                            items.push(resource.path);
                        } else {
                            requestItems.push(resource.path);
                        }
                    }
                });

                // Add references selected by user into requestItems
                if (formActivationCmd === REPLICATION_TYPE_ACTIVATE) {
                    pushSelectedReferences(requestItems);
                }

                if (items.length > 0) {
                    wizard.combinedActions = true;
                    if (!isWizardScheduleOrUseTreeActivation) {
                        url = Granite.HTTP.externalize(wizard.replicationUrl);
                        settings = {
                            "type": form.attr("method") || "POST",
                            "data": {
                                "_charset_": "utf-8",
                                "cmd": encodedFormActivationCmd,
                                "path": items,
                                "agentId": wizard.replicationAgent
                            }
                        };

                    } else {
                        //schedule activation
                        if (scheduleMultiResourceSupport && items.length > 1) {
                            url = Granite.HTTP.externalize(wizard.workflowUrl + PACKAGE_SELECTOR);
                            settings = {
                                "type": form.attr("method") || "POST",
                                "data": {
                                    "_charset_": "utf_8",
                                    "workflowModel": scheduleWorkflowModel,
                                    "absoluteTime": absTime,
                                    "workflowTitle": workflowTitle,
                                    "packageTitle": packageTitle,
                                    "workflowPackagesPath" : PACKAGE_PATH,
                                    "srcPathList": items,
                                    "contentRootPaths": contentRootPaths,
                                    "onlyDirectChildren": onlyDirectChildren,
                                    "filters": filters,
                                    "agentId": wizard.replicationAgent
                                }
                            };
                        } else {
                            url = Granite.HTTP.externalize(wizard.workflowUrl);
                            settings = {
                                "type": form.attr("method") || "POST",
                                "data": {
                                    "_charset_": "UTF-8",
                                    "model": scheduleWorkflowModel,
                                    "absoluteTime": absTime,
                                    "workflowTitle": workflowTitle,
                                    "payload": items,
                                    "contentRootPaths": contentRootPaths,
                                    "onlyDirectChildren": onlyDirectChildren,
                                    "filters": filters,
                                    "payloadType": "JCR_PATH",
                                    "agentId": wizard.replicationAgent
                                }
                            };
                        }
                    }

                    deferreds.push($.ajax(url, settings));
                }
                if (wizard.requestMultiResourceSupport && requestItems.length > 1) {
                    url = Granite.HTTP.externalize(wizard.workflowUrl + PACKAGE_SELECTOR);
                    settings = {
                        "type": form.attr("method") || "POST",
                        "data": {
                            "_charset_": "utf_8",
                            "workflowModel": wizard.requestActivationWorkflow,
                            "absoluteTime": absTime,
                            "workflowTitle": form[0].elements.requestWorkflowTitle.value,
                            "packageTitle": form[0].elements.requestPackageTitle.value,
                            "workflowPackagesPath" : PACKAGE_PATH,
                            "srcPathList": requestItems,
                            "contentRootPaths": contentRootPaths,
                            "onlyDirectChildren": onlyDirectChildren,
                            "includeChildren": includeChildren,
                            "filters": filters,
                            "agentId": wizard.replicationAgent
                        }
                    };
                } else {
                    url = Granite.HTTP.externalize(wizard.workflowUrl);
                    settings = {
                        "type": form.attr("method") || "POST",
                        "data": {
                            "_charset_": "UTF-8",
                            "model": wizard.requestActivationWorkflow,
                            "workflowTitle": form[0].elements.requestWorkflowTitle.value,
                            "absoluteTime": absTime,
                            "payload": requestItems,
                            "contentRootPaths": contentRootPaths,
                            "onlyDirectChildren": onlyDirectChildren,
                            "includeChildren": includeChildren,
                            "filters": filters,
                            "payloadType": "JCR_PATH",
                            "agentId": wizard.replicationAgent
                        }
                    };
                }
                deferreds.push($.ajax(url, settings));
            }
            $.when.apply($, deferreds).done(function() {
                var isPublishToPreview = wizard.destination === DESTINATION_PREVIEW && wizard.replicationType === REPLICATION_TYPE_ACTIVATE;
                var objects = [];
                if (!wizard.combinedActions) {
                    objects.push(Array.prototype.slice.call(arguments));
                } else {
                    objects = Array.prototype.slice.call(arguments);
                }
                var successMessages = [];
                var previewUrls = [];

                for(var i=0; i< objects.length; i++) {
                    replicationStarted(objects[i], successMessages);
                    if (isPublishToPreview) {
                        previewUrls = getPreviewUrls(objects[i], mainItems);
                    }
                }
                if (successMessages.length > 0) {
                    var message = successMessages.join("</br>");
                    var formResponse = form.find(".foundation-form-response-ui-success").data("foundationFormResponseUiSuccess");
                    // store message so that it can be displayed after the redirect
                    try {
                        messenger.put(null, message || Granite.I18n.get("The form has been submitted successfully"), "success");
                        if (isPublishToPreview) {
                            showPreviewPrompt(previewUrls, formResponse.redirect);
                            return;
                        }
                        location.href = formResponse.redirect;
                    } catch (e) {
                        if (window.console) {
                            console.warn("Error occur setting message", e);
                        }
                    }
                }
            }).fail(function() {
                var formResponse = form.find(".foundation-form-response-ui-success").data("foundationFormResponseUiSuccess");
                try {
                    messenger.put(null, Granite.I18n.get("Not enough rights to manage publication."), "error");
                    location.href = formResponse.redirect;
                } catch (e) {
                    if (window.console) {
                        console.warn("Error occur setting message", e);
                    }
                }
            });
        }
    }

    function showToast(message) {
        const toast = new Coral.Toast().set({
            content: {
              textContent: message
            }
          });
          toast.show();
    }

    function getPreviewUrls(result, mainItems) {
        var listOfObjects = [];
        if(Granite.Toggles.isEnabled(FT_PUBLISH_TO_PREVIEW)) {
            if (previewUrl) {
                $.ajax(Granite.HTTP.externalize('/mnt/overlay/wcm/core/content/contentPreviewUrl.json'), {
                    "type": "POST",
                    "async": false,
                    "dataType": "json",
                    "data": {
                        paths: mainItems
                    }
                }).done(function(data) {
                    for (var key in data){
                        if(data[key] !== "") {
                            listOfObjects.push(previewUrl.slice(0, -1) + data[key]);
                        }
                    }
                });
            }
        } else {
            if (previewUrl) {
                listOfObjects = mainItems.map(item => previewUrl.slice(0, -1) + item + ".html");
            }
        }
        return listOfObjects;
    }

    function showPreviewPrompt(previewUrls, redirectUrl) {

        var promptMessageHTML = "";
        var showWarning = false;
        if (previewUrls.length > 0) {
            var isMultiple = previewUrls.length > 1;

            var promptMessage = isMultiple ? "Your previews have been created" : "Your preview has been created";
            promptMessageHTML = "<p>" + Granite.I18n.get(promptMessage) + "</p>";
            promptMessageHTML += '<table is="coral-table"> <thead is="coral-table-head" ><tr is="coral-table-row"><th is="coral-table-headercell">' + Granite.I18n.get("Link") + '</th></thead>'

            promptMessageHTML += '<tbody is="coral-table-body">'

            previewUrls.forEach(function(url) {
                promptMessageHTML += '<tr is="coral-table-row">'
                promptMessageHTML += '<td is="coral-table-cell"><a target="_blank" is="coral-textfield" href="' + url + '">' + url + '</a></td>'
                promptMessageHTML += '<td is="coral-table-cell"><button data-copy="' + url + '" is="coral-button" icon="copy" iconsize="S" size="S" variant="quietaction" class="copy-button"></button></td>'
                promptMessageHTML += '</tr>';
            });

            promptMessageHTML += '</tbody></table>'
        } else {
            showWarning = true;
            var promptMessage = "Unable to generate preview URLs, please follow the documentation on how to " +
                "<a target='_blank' href='https://www.adobe.com/go/aem_cloud_previewing_content_en'>configure Preview service</a>.";
            promptMessageHTML = "<p>" + Granite.I18n.get(promptMessage) + "</p>";
        }

        var promptActions = [];
        if (!showWarning) {
            promptActions.push({
                text: Granite.I18n.get("Copy Links"),
                variant: "secondary",
                handler: function() {
                    const copyButtons = document.querySelectorAll('coral-dialog .copy-button')
                    const links = Array.from(copyButtons).map(button => button.dataset.copy)
                    copyToClipboard(links.join("\n"))
                    showToast(Granite.I18n.get("Links copied!"))
                }
            })
        }
        promptActions.push({
            text: Granite.I18n.get("Done"),
            variant: "primary",
            handler: function() {
                location.href = redirectUrl;
            }
        });

        ui.clearWait();

        customPrompt(showWarning ? "Warning" : "Success", promptMessageHTML, showWarning ? "warning" : "default", promptActions);

        const buttons = document.querySelectorAll('coral-dialog .copy-button')
        Array.from(buttons).forEach(button => {
            button.addEventListener("click", function () {
                copyToClipboard(button.dataset.copy)
                showToast(Granite.I18n.get("Link copied!"))
            });
        });
    }

    function customPrompt(title, message, type, actions, callback) {
        let el = new Coral.Dialog().set({
            backdrop: Coral.Dialog.backdrop.STATIC,
            interaction: "off"
        }).on("coral-overlay:close", function (e) {
            e.target.remove();
        });
        el.variant = type || "default";
        el.header.textContent = title || "";
        el.content.innerHTML = message || "";
        el.footer.innerHTML = "";
        actions.forEach(function (a) {
            addAction(a, el, callback);
        });

        document.body.appendChild(el);
        el.show();


    }

    function addAction(a, el, callback) {
        var b = new Coral.Button();
        b.label.textContent = a.text;
        if (a.id) {
            b.id = a.id;
        }

        b.variant = a.variant || "primary";
        if (b.variant === "primary") {
            // Primary action receives focus when dialog opens.
            el.focusOnShow = b;
        }

        b.on("click", function (e) {
            if (b.variant === "primary") {
                el.hide();
            }

            if (a.handler) {
                a.handler(a);
            }

            if (callback) {
                callback(a.id, a);
            }
        });

        el.footer.appendChild(b);
    }

    function copyToClipboard(copytext) {
        if (window.clipboardData && window.clipboardData.setData) {
            // Internet Explorer-specific code path to prevent textarea being shown while dialog is visible.
            return window.clipboardData.setData("Text", copytext);
        }
        else if (document.queryCommandSupported && document.queryCommandSupported("copy")) {
            var textarea = document.createElement("textarea");
            textarea.textContent = copytext;
            textarea.style.position = "fixed";  // Prevent scrolling to bottom of page in Microsoft Edge.
            document.body.appendChild(textarea);
            textarea.select();
            try {
                return document.execCommand("copy");  // Security exception may be thrown by some browsers.
            }
            catch (ex) {
                console.warn("Copy to clipboard failed.", ex);
                return false;
            }
            finally {
                document.body.removeChild(textarea);
            }
        }
    }

    ManagePublication.removeWorkflowsStep = function(wizard, step) {
        wizard.workflowsStep = step.clone(true);
        var lastStepControls = $(wizard).find(".foundation-layout-wizard2-controls > coral-panel").last();
        wizard.workflowsStep.append(lastStepControls.find(".foundation-wizard-control").clone(true));
        var wizardApi = $(wizard).adaptTo("foundation-wizard");
        wizard.workflowsStep.attr("data-foundation-wizard-step-title", $(wizard).find("coral-steplist coral-step:last-of-type coral-step-label")[0].textContent);
        wizardApi.remove(step);

        lastStepControls = $(wizard).find(".foundation-layout-wizard2-controls > coral-panel").last();
        var nextControl = lastStepControls.find(".foundation-wizard-control[data-foundation-wizard-control-action='next']")[0];
        nextControl.type = "submit";
    }

    ManagePublication.appendWorkflowsStep = function(wizard, step) {

        var wizardApi = $(wizard).adaptTo("foundation-wizard");
        var lastStepControls = $(wizard).find(".foundation-layout-wizard2-controls > coral-panel").last();
        var nextControl = lastStepControls.find(".foundation-wizard-control[data-foundation-wizard-control-action='next']")[0];
        nextControl.type = "button";
        nextControl.textContent = Granite.I18n.get("Next");

        wizardApi.append([step]);

        $(wizard).find("coral-steplist coral-step:last-of-type coral-step-label")[0].textContent = step.attr("data-foundation-wizard-step-title");
        $(wizard).find(SUBMIT_BUTTON_SELECTOR).on("click", function(event) {
            event.preventDefault();
            event.stopPropagation();
            form.submit();
        });
    }

    function replicationStarted(result, messages) {
        //Results argument structure [response, status, xhr]
        var status = result[1];
        var xhr = result[2];
        var isWizardScheduleOrUseTreeActivation = wizard.schedule || wizard.useTreeActivation;
        if (status === "success") {
            var formResponse = form.find(".foundation-form-response-ui-success").data("foundationFormResponseUiSuccess");
            var cmd = $(REPLICATION_TYPE_FIELD_SELECTOR).val();
            var action = cmd === REPLICATION_TYPE_ACTIVATE ? "published" : "unpublished";
            var requestAction = cmd === REPLICATION_TYPE_ACTIVATE ? "publication" : "unpublication";
            var i18nScheduledPublication = Granite.I18n.get("Resource(s) have been scheduled for publication");
            var i18nScheduledUnpublication = Granite.I18n.get("Resource(s) have been scheduled for unpublication");
            var i18nRequestedPublication = Granite.I18n.get("Resource(s) have been requested for publication");
            var i18nRequestedUnpublication = Granite.I18n.get("Resource(s) have been requested for unpublication");

            var message = Granite.I18n.get(formResponse.message, Granite.I18n.getVar(action));
            // Easier to translate if a complete string
            if (formResponse.message === Granite.I18n.get("Resource(s) have been {0}.")) {
                if (action === "published") {
                    message = Granite.I18n.get("Resource(s) have been published.");
                } else {
                    message = Granite.I18n.get("Resource(s) have been unpublished.");
                }
            }

            if (wizard.combinedActions) {
                if (isWizardScheduleOrUseTreeActivation) {
                    // message changes if activation date has been specified
                    message = requestAction === "publication" ? i18nScheduledPublication : i18nScheduledUnpublication;
                    messages.push(message);
                }
                if (!wizard.hasReplicationRights) {
                    message = requestAction === "publication" ? i18nRequestedPublication : i18nRequestedUnpublication;
                }
                wizard.combinedActions = false;
                messages.push(message);
            } else {
                if (isWizardScheduleOrUseTreeActivation) {
                    // message changes if activation date has been specified
                    message = requestAction === "publication" ? i18nScheduledPublication : i18nScheduledUnpublication;
                } else if (!wizard.hasReplicationRights) {
                    message = requestAction === "publication" ? i18nRequestedPublication : i18nRequestedUnpublication;
                }
                messages.push(message);
            }
        } else {
            ui.clearWait();
            var errorMsg = "";
            if (wizard.hasReplicationRights && isWizardScheduleOrUseTreeActivation) {
                errorMsg = Granite.I18n.get("Failed to schedule the selected resource(s).");
            } else if (!wizard.hasReplicationRights) {
                errorMsg = Granite.I18n.get("Failed to request publishing for the selected resource(s).");
            } else {
                errorMsg = Granite.I18n.getVar($(xhr.responseText).find("#Message").text());
            }
            ui.notify("", errorMsg ? Granite.I18n.getVar(errorMsg) : Granite.I18n.get(form.data("errormessage")), "error");
        }
    }

    function revalidateStep(step) {
        if (step.data("foundationWizardStepValidation") === false) {
            return true;
        }

        var allValid = true;

        step.adaptTo("foundation-validation-helper").getSubmittables().forEach(function(submittable) {
            var $submittable = $(submittable);

            if (!$submittable.is(":visible")) {
                return;
            }

            var fieldApi = $submittable.adaptTo("foundation-field");
            if (fieldApi) {
                if (fieldApi.isDisabled()) {
                    return;
                }
            } else if ($submittable.is(":disabled")) {
                return;
            }

            var validationApi = $submittable.adaptTo("foundation-validation");
            if (validationApi) {
                if (!validationApi.checkValidity()) {
                    allValid = false;
                }
                validationApi.updateUI();
            }
        });

        step.data("foundation-wizard-step.internal.valid", allValid);

        return allValid;
    }

    ManagePublication.defaultClearMessage = function(field) {
        var error = field.data("foundation-validation.internal.error");
        if (error) {
            var tooltip = $(error).data("foundation-validation.internal.error.tooltip");
            tooltip.hide();
            tooltip.remove();

            error.remove();
        }

        var $errorLabel = field.siblings(".coral-Form-errorlabel");
        if ($errorLabel.length) {
            $errorLabel.remove();
        }

        field.removeAttr("invalid");
        field.removeClass("is-invalid");
        field.attr("aria-invalid", false);
    }

    ManagePublication.validateHandler = function(e) {
        e.stopPropagation();
        e.preventDefault();

        var isValidStep = revalidateStep(wizard.find(".foundation-wizard-step-active"));
        wizard.adaptTo("foundation-wizard").toggleNext(isValidStep);
    }

    function appendDestinationTextToElement(destination, element) {
        if (!shouldShowDestination) return;
        if (!element) return;

        var destinationTextEl = element.querySelector(DESTINATION_TEXT_SELECTOR);

        if (!destinationTextEl) {
            destinationTextEl = document.createElement("span");
            destinationTextEl.className = DESTINATION_TEXT_SELECTOR.substring(1);
            element.appendChild(destinationTextEl);
        }

        var destinationText = destination === DESTINATION_PREVIEW ? ACTION_TEXT_PREVIEW : ACTION_TEXT_PUBLISH;
        destinationTextEl.innerText = " (" + destinationText + ")";
    }

    function appendDestinationTextToWizardTitle(destination) {
        var wizardTitle = document.querySelector(WIZARD_SELECTOR + " .coral-Heading");
        appendDestinationTextToElement(destination, wizardTitle);
    }

    /**
     * @typedef {object} SubmitButtonConfig
     * @property {"Activate"|"Deactivate"} replicationType
     * @property {"publish"|"preview"=} destination
     * @property {boolean} hasReplicationRights
     * @property {boolean} isScheduled
     */

    /**
     * @param {SubmitButtonConfig} config
     */
    ManagePublication.setSubmitButtonLabel = function(config) {
        var $submitBtn = $(SUBMIT_BUTTON_SELECTOR);
        if (config.hasReplicationRights) {
            var actionText = getActionText(config);
            $submitBtn.text(Granite.I18n.get(actionText));
        } else {
            var requestText = getRequestActionText(config);
            $submitBtn.text(Granite.I18n.get(requestText));
        }
    }

    /**
     * @param {SubmitButtonConfig} config
     */
    function getActionText(config) {
        var activationDate = form[0].elements.activationDate;
        var datePickerElem = activationDate.parentElement;
        var laterSuffix = !datePickerElem.disabled;
        var action = config.replicationType === REPLICATION_TYPE_DEACTIVATE ? ACTION_TEXT_UNPUBLISH : ACTION_TEXT_PUBLISH;

        if (laterSuffix) {
            action += " later";
        }
        return action;
    }

    /**
     * @param {SubmitButtonConfig} config
     */
    function getRequestActionText(config) {
        var actionToRequest = config.replicationType === REPLICATION_TYPE_DEACTIVATE ? "unpublication" : "publication";

        return "Request " + actionToRequest;
    }

    ManagePublication.getChildResourcePageList = function() {
        return wizard.childResourcePageList;
    }

    $document.ready(function () {
        form = _getFormElement();
        wizard = _getWizardFromForm(form);
        table = $(TABLE_SELECTOR)[0];

        var destinationFieldRendered = document.querySelector(DESTINATION_FIELD_SELECTOR) !== null;
        shouldShowDestination = destinationFieldRendered;

        wizard.workflowsStepDetached = false;

        wizard.hasReplicationRights = true;
        wizard.destination = DESTINATION_PUBLISH;
        wizard.replicationAgent = DEFAULT_REPLICATION_AGENT_ID;

        wizard.on("foundation-wizard-stepchange", function(e, to, from) {
            // call validation first for every case
            ManagePublication.validateHandler(e);

            // Exit if not publishing
            if (wizard.replicationType !== REPLICATION_TYPE_ACTIVATE) return;

            // Exit if not moving from scope step to workflows step.
            var $oldStep = $(from);
            var $newStep = $(to);
            if (!$newStep.hasClass(WORKFLOWS_STEP_CLASS) || !$oldStep.hasClass(SCOPE_STEP_CLASS)) return;

            // Exit if user has already interacted with Include Children Settings dialog.
            var $onlyDirectChildren = form.find("input[type='hidden'][name='onlyDirectChildren']");
            if ($onlyDirectChildren.length) return;

            // We are publishing later, moving from scope step to workflows step and the user has not interacted with
            // the Include Children Settings dialog => so, we trigger the children confirm event to set them to the default values.
            $document.trigger($.Event("global-include-children-confirm", { params: {} }));
        });

        // Scheduling: Now vs Later
        $document.on("change" + ns, SCHEDULING_FIELD_SELECTOR, function(e) {
            var replicationType = $(REPLICATION_TYPE_FIELD_SELECTOR);
            var activationDate = form[0].elements.activationDate;
            var datePickerElem = activationDate.parentElement;
            var $datePicker = $(datePickerElem);

            var fieldAPI = $datePicker.adaptTo("foundation-field");
            if (fieldAPI) {
                var childTarget = e.target.querySelector("coral-radio[checked]");
                var value = e.target.value !== undefined ? e.target.value : (childTarget !== null ? childTarget.value : SCHEDULING_NOW);
                var isScheduled = value === SCHEDULING_LATER;
                fieldAPI.setDisabled(!isScheduled);
                fieldAPI.setRequired(isScheduled);
            }

            wizard.schedule = !datePickerElem.disabled;
            wizard.useTreeActivation = ManagePublication._shouldUseTreeActivation();
            form.attr("data-use-tree-activation", wizard.useTreeActivation ? "true" : "");
            _updateWizardSteps(wizard);
            ManagePublication._updateWorkflowsInfo();

            if (datePickerElem.disabled) {
                ManagePublication.defaultClearMessage($datePicker);
            }
            ManagePublication.setSubmitButtonLabel({
                destination: wizard.destination,
                replicationType: replicationType.val(),
                hasReplicationRights: wizard.hasReplicationRights,
                isScheduled: wizard.schedule
            });
            ManagePublication.validateHandler(e);
        });

        // Destination: publish vs preview
        $document.on("change" + ns, DESTINATION_FIELD_SELECTOR, function(e) {
            var defaultValue = DESTINATION_PUBLISH;
            var value = defaultValue;
            var activationDate = form[0].elements.activationDate;
            var datePickerElem = activationDate.parentElement;

            if (e.target && typeof e.target.value !== "undefined") {
                value = e.target.value;
            } else if (e.target) {
                var checkedRadio = e.target.querySelector("coral-radio[checked]");
                if (checkedRadio) {
                    value = checkedRadio.value;
                }
            }

            wizard.destination = value;
            ManagePublication._updateHiddenField(wizard, "destination", null, value);

            var isPreview = (value === DESTINATION_PREVIEW);
            if(value === DESTINATION_PUBLISH || value === DESTINATION_PREVIEW) {
                wizard.replicationAgent = isPreview ? PREVIEW_REPLICATION_AGENT_ID : DEFAULT_REPLICATION_AGENT_ID;
            }
            if (isPreview) {
                if (!previewUrl) {
                    fetchPreviewUrl();
                }
                if (!Granite.Toggles.isEnabled(FT_TREE_ACTIVATION_PREVIEW)) {
                    ManagePublication.setScheduling(SCHEDULING_NOW);
                }
            }

            if(value === DESTINATION_PREVIEW || value === DESTINATION_PUBLISH) {
                ManagePublication.toggleSchedulingLaterRadio(!isPreview || Granite.Toggles.isEnabled(FT_TREE_ACTIVATION_PREVIEW));
                appendDestinationTextToWizardTitle(wizard.destination);
            }
            ManagePublication.setSubmitButtonLabel({
                destination: wizard.destination,
                replicationType: wizard.replicationType,
                hasReplicationRights: wizard.hasReplicationRights,
                isScheduled: wizard.schedule
            });

            resetReferencesForChildResourcePages();

            wizard.schedule = !datePickerElem.disabled;
            wizard.useTreeActivation = ManagePublication._shouldUseTreeActivation();
            form.attr("data-use-tree-activation", wizard.useTreeActivation ? "true" : "");
            _updateWizardSteps(wizard);
            ManagePublication._updateWorkflowsInfo();
            ManagePublication.validateHandler(e);
        });

        // Replication Type: Publish vs Unpublish
        $document.on("change" + ns, REPLICATION_TYPE_FIELD_SELECTOR, function (e) {
            var activationDate = form[0].elements.activationDate;
            var datePickerElem = activationDate.parentElement;

            wizard.replicationType = $(REPLICATION_TYPE_FIELD_SELECTOR).val();
            form.attr("data-replication-type", wizard.replicationType);

            wizard.schedule = !datePickerElem.disabled;
            wizard.useTreeActivation = ManagePublication._shouldUseTreeActivation();
            form.attr("data-use-tree-activation", wizard.useTreeActivation ? "true" : "");
            $(_getTable(wizard)).trigger("foundation-selections-change");
            _updateWizardSteps(wizard);

            ManagePublication.setSubmitButtonLabel({
                destination: wizard.destination,
                replicationType: wizard.replicationType,
                hasReplicationRights: wizard.hasReplicationRights,
                isScheduled: wizard.schedule
            });

            //toggle References column
            if (wizard.replicationType === REPLICATION_TYPE_ACTIVATE) {
                table.querySelector("col[data-foundation-layout-table-column-name='column-refrences']").hidden = false;
                wizard.scheduleActivationWorkflow = form.data("scheduleactivationworkflow");
                wizard.scheduleTreeActivationWorkflow = form.data("scheduletreeactivationworkflow");
                wizard.requestActivationWorkflow = form.data("requestactivationworkflow");
            } else {
                //hide references column
                table.querySelector("col[data-foundation-layout-table-column-name='column-refrences']").hidden = true;
                wizard.scheduleActivationWorkflow = form.data("scheduledeactivationworkflow");
                wizard.scheduleTreeActivationWorkflow = null;
                wizard.requestActivationWorkflow = form.data("requestdeactivationworkflow");
            }

            $.ajax({
                url: Granite.HTTP.internalize("/mnt/overlay/cq/gui/content/common/managepublicationwizard/workflowsresourceconfig.json" + wizard.scheduleActivationWorkflow),
                type: "GET",
                dataType: "json",
                success: function (responseJson) {
                    wizard.scheduleMultiResourceSupport = false;
                    if (responseJson.hasOwnProperty("multiResourceSupport")) {
                        wizard.scheduleMultiResourceSupport = responseJson.multiResourceSupport;
                    }
                    if (responseJson.hasOwnProperty("title")) {
                        wizard.scheduleWorkflowTitle = responseJson.title;
                    }
                }
            });

            if (wizard.scheduleTreeActivationWorkflow) {
                $.ajax({
                    url: Granite.HTTP.internalize("/mnt/overlay/cq/gui/content/common/managepublicationwizard/workflowsresourceconfig.json" + wizard.scheduleTreeActivationWorkflow),
                    type: "GET",
                    dataType: "json",
                    success: function (responseJson) {
                        wizard.scheduleTreeWorkflowTitle = Granite.I18n.get("Schedule Tree Workflow");
                        wizard.scheduleTreeMultiResourceSupport = false;
                        if (responseJson.hasOwnProperty("multiResourceSupport")) {
                            wizard.scheduleTreeMultiResourceSupport = responseJson.multiResourceSupport;
                        }
                        if (responseJson.hasOwnProperty("title") && responseJson.title.length) {
                            wizard.scheduleTreeWorkflowTitle = responseJson.title;
                        }
                    }
                });
            }

            $.ajax({
                url: Granite.HTTP.internalize("/mnt/overlay/cq/gui/content/common/managepublicationwizard/workflowsresourceconfig.json" + wizard.requestActivationWorkflow),
                type: "GET",
                dataType: "json",
                success: function (responseJson) {
                    wizard.requestMultiResourceSupport = false;
                    if (responseJson.hasOwnProperty("multiResourceSupport")) {
                        wizard.requestMultiResourceSupport = responseJson.multiResourceSupport;
                    } else {
                        var keepPackageCheck = $(".cq-sites-startbulkworkflows-keeppackage");

                        if (keepPackageCheck[0].checked) {
                            keepPackageCheck[0].checked = false;
                        }
                        keepPackageCheck[0].disabled = !wizard.requestMultiResourceSupport;
                        keepPackageCheck.trigger("change");
                    }
                    if (responseJson.hasOwnProperty("title")) {
                        wizard.requestWorkflowTitle = responseJson.title;
                    }
                    ManagePublication._updateWorkflowsInfo();
                }
            });
            ManagePublication.validateHandler(e);
        });

        form.on("change" + ns, ".cq-sites-startbulkworkflows-keeppackage-request", function (e) {
            var packageTitle = form[0].elements.requestPackageTitle;
            var fieldAPI = $(packageTitle).adaptTo("foundation-field");
            if (fieldAPI) {
                fieldAPI.setDisabled(!this.checked);
                fieldAPI.setRequired(this.checked);

            }

            // This is a disabled field
            if (!this.checked) {
                fieldAPI.isValidated = false;
                ManagePublication.defaultClearMessage($(packageTitle));
            }

            ManagePublication.validateHandler(e);
        });

        form.on("change" + ns, ".cq-sites-startbulkworkflows-keeppackage-schedule", function (e) {
            var packageTitle = form[0].elements.schedulePackageTitle;
            var fieldAPI = $(packageTitle).adaptTo("foundation-field");
            if (fieldAPI) {
                fieldAPI.setDisabled(!this.checked);
                fieldAPI.setRequired(this.checked);

            }

            // This is a disabled field
            if (!this.checked) {
                fieldAPI.isValidated = false;
                ManagePublication.defaultClearMessage($(packageTitle));
            }

            ManagePublication.validateHandler(e);
        });

        form.on("change" + ns, "input[name=scheduleWorkflowTitle], input[name=schedulePackageTitle], input[name=requestWorkflowTitle], input[name=requestPackageTitle]", ManagePublication.validateHandler);
        form.on("input" + ns, "input[name=scheduleWorkflowTitle], input[name=schedulePackageTitle], input[name=requestWorkflowTitle], input[name=requestPackageTitle]", function(e) {
            e.preventDefault();
            e.stopPropagation();
        });

        //Include Children
        $document.on("include-children-confirm", function (event) {
            _updateItemIncludeSubPages(wizard, event.resources);
        });

        $document.on("global-include-children-confirm", function (event) {
            ManagePublication._updateIncludeChildrenParams(wizard, event.params);
            ManagePublication._updateWorkflowsInfo();
        });

        $document.on("publish-references-confirm", function (event) {
            _updateItemReferences(wizard, event);
        });

        //Submit form
        form.off("submit" + ns).on("submit" + ns, function (e) {
            e.preventDefault();
            e.stopPropagation();

            var items = [];

            var paths = $("input[type=hidden][name=srcPathList]").map(function(index, item) {
                return item.value;
            });

            if (!paths.length) return;

            ui.wait();

            // flatten the array
            items = [].concat.apply([], paths);

            var replicationType = form[0].elements.activationCommand.value;

            ManagePublication.manageReplicationAction(replicationType, wizard.destination, items);
        });

        //Remove selection
        wizard.find(".foundation-collection-action-delete").click(function () {
            ui.prompt(Granite.I18n.get("Remove"),
                Granite.I18n.get("Do you really want to remove selected pages?"),
                "error",
                [{
                    text: Granite.I18n.get("Cancel"),
                    id: "no"
                },
                    {
                        text: Granite.I18n.get("Remove"),
                        id: "yes",
                        warning: true
                    }],
                function (btnId) {
                    if (btnId === "yes") {
                        _handleDeleteBtnClick(wizard);
                    }
                });
        });

        registry.register("foundation.picker.control.action", {
            name: "cq.commons.addcontent",
            handler: function (name, el, config, selections) {
                if ((selections.length > 0)) {
                    ui.wait();
                    var bAdded = false;
                    var bRootPath = false;

                    // get the misisng items to update the references
                    var missingItems = [];
                    selections.forEach(function (selection) {
                        var path = selection.value;
                        if (path !== '/content') {
                            var currentItem = _getItemFromPath(wizard, path);
                            if (currentItem == null) {
                                missingItems.push(path);
                            }
                        }
                    });
                    var promisses = [];
                    var loadMissingItemsConf;
                    if(ManagePublication.loadMissingItemsConf && missingItems.length > 0) {
                        loadMissingItemsConf = ManagePublication.loadMissingItemsConf(missingItems);
                    }
                    $.when(loadMissingItemsConf).then(function() {
                        selections.forEach(function (selection) {
                            var strResourcePath = selection.value;
                            if (strResourcePath !== '/content') {
                                var currentItem = _getItemFromPath(wizard, strResourcePath);
                                if (currentItem == null) {
                                    var promise = _appendResourcePage(wizard, strResourcePath, true);
                                    promisses.push(promise);
                                    bAdded = true;
                                }
                            } else {
                                bRootPath = true;
                            }
                        });

                        // update the references in the aggregated list
                        _manageReferences('update', {'path': missingItems})
                            .fail(fetchingReferencesError)
                            .always(function() {
                                $.when.apply($, promisses).fail(function() {
                                    ui.prompt(Granite.I18n.get("Error"),
                                        Granite.I18n.get("Selected resources are not valid."),
                                        "error",
                                        [{
                                            text: Granite.I18n.get("Ok"),
                                            id: "no"
                                        }]
                                    );
                                }).always(function() {
                                    ui.clearWait();
                                });

                                if (!bAdded && !bRootPath) {
                                    ui.prompt(Granite.I18n.get("Error"),
                                        Granite.I18n.get("Selected page already exist in the list."),
                                        "error",
                                        [{
                                            text: Granite.I18n.get("Ok"),
                                            id: "no"
                                        }]
                                    );
                                }
                            });
                    })
                }
            }
        });

        registry.register("foundation.collection.action.activecondition", {
            name: "managepublication.action.hasReferences",
            handler: function (name, el, config, collection, selections) {
                var items = selections.map(function (item) {
                    return $(item).data("foundation-collection-item-id");
                });
                var isActivate = document.querySelector(REPLICATION_TYPE_FIELD_SELECTOR).value === REPLICATION_TYPE_ACTIVATE;
                // Show Published References action only if destination is Publish or Preview
                var showReferences = wizard.destination === DESTINATION_PUBLISH || wizard.destination === DESTINATION_PREVIEW;
                if (!(isActivate && showReferences)) {
                    return false;
                }
                _getReferences(items).done(function (json) {
                    if (json.assets.length > 0) {
                        $(el).removeClass("foundation-collection-action-hidden");
                    } else {
                        $(el).addClass("foundation-collection-action-hidden");
                    }
                    if(ManagePublication._showOrHideCollectionAction) {
                        ManagePublication._showOrHideCollectionAction(el);
                    }
                });
                return false;
            }
        });

        // autoselect source page
        Coral.commons.ready(wizard[0], function () {
            handlePagination(wizard, $(_getTable(wizard)), {}, paginator);
            var path_array = [];
            var url_params = _parseUrlParams();
            if (url_params && url_params['item'] && url_params['item'].length > 0) {
                if (Object.prototype.toString.call(url_params['item']) === '[object Array]') {
                    path_array = url_params['item'];
                } else if (url_params['item'].length > 0) {
                    path_array.push(url_params['item']);
                }

            } else if (window.location.hash) {
                var path = window.location.hash.substring(1);
                path_array = path.split(',');
            } else if (form.data("requestpaths")) {
                path_array = form.data("requestpaths");
            }
            if (!wizard.childResourcePageList) {
                wizard.childResourcePageList = [];
            }
            wizard.replicationUrl = form.data("replicationurl");

            wizard.workflowUrl = form.data("workflowurl");

            var errorHandler = function() {
                ui.prompt(Granite.I18n.get("Error"),
                    Granite.I18n.get("Selected resources are not valid."),
                    "error",
                    [{
                        text: Granite.I18n.get("Ok"),
                        id: "no"
                    }]
                );
                _refreshChildPageListUI(wizard);
            };

            Coral.commons.ready(table, function (el) {
                window.requestAnimationFrame(function () {
                    table = el;
                    table.items.remove(table.items.getAll()[0]);

                    if (path_array && path_array.length > 0) {
                        for (var index = 0; index < path_array.length; index++) {
                            $.when(_appendResourcePage(wizard, path_array[index], true)).fail(errorHandler);
                        }
                    } else {
                        _refreshChildPageListUI(wizard);
                    }

                    // get aggregated references for all items
                    _manageReferences('update', {'path': path_array})
                      .fail(fetchingReferencesError);
                });
            });
        });
    });

    function resetReferencesForChildResourcePages() {
        //restore references and associated info for each item
        var items = wizard.childResourcePageList;
        items.forEach(function (currentItem) {
            var deferred  = $.Deferred();
            if (currentItem.cache.references) {
                // get references
                currentItem.cache.references = {};
                currentItem.cache.references.all = {};
                currentItem.cache.references.total = 0;

                _getReferences([currentItem.path]).success(function (json) {
                    var refs = [];
                    for (var i = 0; i < json.assets.length; i++) {
                        var path = json.assets[i].path;
                        refs.push(path);
                        _updateReference(path, true, true);
                    }

                    currentItem.cache.references = {};
                    currentItem.cache.references.all = refs;
                    currentItem.cache.references.total = refs.length;
                    currentItem.cache.references.description = ManagePublication._getReferencesInfo(currentItem);
                    ManagePublication._updateReferenceInfo(currentItem);
                    deferred.resolve();
                }).fail(function() {
                    deferred.reject();
                });
            }
        });
        _updateReferencesHiddenFields();
        $(_getTable(wizard)).trigger("foundation-selections-change");
    }
})(document, Granite, Granite.$, window);
