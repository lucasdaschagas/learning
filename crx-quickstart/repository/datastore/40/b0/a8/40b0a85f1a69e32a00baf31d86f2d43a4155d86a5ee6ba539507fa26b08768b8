/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2017 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(function(b){b.pkg("s7sdk.image");b.Util.require("s7sdk.common.IS");b.Util.require("s7sdk.common.ItemDesc");b.Util.require("s7sdk.libs.three.three");b.Util.require("s7sdk.common.Enumeration");b.Util.require("s7sdk.event.Event");b.Util.require("s7sdk.event.PanoramicController");if(!b.image.PanoramicViewControl){b.image.PanoramicViewControl=function(c){arguments.callee.superclass.apply(this,[c,b.image.PanoramicViewControl.NS,c.constructor,b.image.PanoramicView.RESTRICTED_STYLES])};b.image.PanoramicViewControl.NS="s7sdk.image.PanoramicViewControl";b.image.PanoramicViewControl.prototype.getCurrentAsset=function(){return this.component.getAsset()};b.image.PanoramicViewControl.prototype.setCurrentAsset=function(c){this.component.setAsset(c)};b.image.PanoramicViewControl.prototype.rebuild=function(d){if(this.component){var c=this.component.oldAsset;this.superproto.rebuild.apply(this,[d]);if(c){this.component.oldAsset=c}}};b.image.PanoramicViewControl.prototype.setVRRender=function(d){if(this.component){var c=(this.dynamicModifiers?this.dynamicModifiers:b.Util.resolveModifier("","",this.component,this.component.settings));c["vrrender"]=d?"true":"false";this.rebuild(c)}}}b.Class.inherits(b.image.PanoramicViewControl.NS,"s7sdk.ControlComponent");if(!b.image.PanoramicView){b.image.PanoramicView=function PanoramicView(c,e,k){var g=!!arguments[3];b.Logger.log(b.Logger.CONFIG,"s7sdk.image.PanoramicView constructor - container: %0, settings: %1 , compId: %2",c,e,k);arguments.callee.superclass.apply(this,[k,c,"div","s7panoramicview",e,!g]);k=(typeof k=="string"&&k.length)?k:"PanoramicView_"+b.Util.createUniqueId();this.id=(b.Util.isNull(k)?"":k);this.createElement();this.container=this.getParent();if(this.container.tagName=="DIV"&&(!this.container.style.position||this.container.style.position=="static")){this.container.style.position="relative"}this.serverUrl=b.Util.normalizeUrl(this.serverUrl);this.compId=(b.Util.isNull(k)?"":k);this.locale=this.getParam("locale","");this.imageModifier=b.MediaSetParser.parseAssetForSetReq(this.asset).mod;this.requestUrl=null;this.reqWid=0;this.reqHei=0;if(!this.wid||!this.hei){this.wid=parseInt(b.Util.css.getCss("s7panoramicview","width",this.compId,null,this.container));this.hei=parseInt(b.Util.css.getCss("s7panoramicview","height",this.compId,null,this.container));if(!b.Util.isNumber(this.wid)||!b.Util.isNumber(this.hei)||this.wid<=0||this.hei<=0){if("clientHeight" in this.container&&"clientWidth" in this.container){this.wid=this.container.clientWidth;this.hei=this.container.clientHeight}if(this.wid==0||this.hei==0){this.wid=600;this.hei=300}}}this.item=null;var i=b.Util.resolveURL(this.serverUrl,b.MediaSetParser.parseAssetForSetReq(this.asset).req);if(b.Util.isNonEmptyString(this.locale)){i+="&locale="+this.locale}this.mediaSet=null;this.oldAsset=null;this.obj.style.width=this.wid+"px";this.obj.style.height=this.hei+"px";if(!this.hint){this.hint=document.createElement("span");this.hint.id=this.id+"_hint";this.hint.style.display="none";this.hint.innerText=this.getLocalizedText("USAGE_HINT");this.obj.appendChild(this.hint)}this.obj.setAttribute("tabindex",0);this.obj.setAttribute("role","application");this.obj.setAttribute("aria-roledescription",this.getLocalizedText("ROLE_DESCRIPTION"));this.obj.setAttribute("aria-describedby",this.hint.id);this.initLoad=true;this.initCalled=false;this.controls=null;this.sphere=null;this.renderer=null;this.scene=null;this.camera=null;this.effect=null;this.map=null;this.render=this.render.bind(this);this.helperCanvas=b.Util.createElement("canvas");this.helperImage=null;this.attachToContainer();var l=this;this.viewIsReadySent=false;if(this.vrRender){function j(){var m;m=document.createElement("button");m.id=l.id+"_specbtn";m.className="s7trackdeviceorientationbutton";m.textContent=l.getLocalizedText("TRACK_DEVICE_ORIENTATION");m.style.display="none";return m}function h(n){n.style.display="block";var m=n;n.onclick=n.ontouchend=function(o){b.Event.preventDefault(o);window.DeviceOrientationEvent.requestPermission()["then"](function(p){if(p=="granted"){f(m)}else{f(m)}})["catch"](function(p){f(m)})}}function f(m){m.style.display="none";m.onclick=null;m.ontouchend=null}var d=j();this.obj.appendChild(d);if(window.DeviceOrientationEvent!==undefined&&typeof window.DeviceOrientationEvent.requestPermission==="function"){h(d)}else{f(d)}}if(this.asset&&this.asset.length>0){this.isReq=new b.IS();this.currentAsset=this.asset;this.isReq.getHttpReq(i,function(n,m){b.image.PanoramicView.prototype.loadRequest.apply(m,[n])},null,this)}if(!g){return new b.image.PanoramicViewControl(this)}else{return this}};b.Class.inherits("s7sdk.image.PanoramicView","s7sdk.UIComponent");b.image.PanoramicView.prototype.modifiers={serverUrl:{params:["isRootPath"],defaults:["/is/image/"]},asset:{params:["asset"],defaults:[""],parseParams:false},vrRender:{params:["enabled"],defaults:[false]},fmt:{params:["fmt"],defaults:["jpg"],ranges:[["jpg","jpeg","png","png-alpha","gif","gif-alpha"]]},autorotate:{params:["enabled"],defaults:[true]}};b.image.PanoramicView.RESTRICTED_STYLES={};b.image.PanoramicView.prototype.setCSS=function(e,d,c){if(this.isRestrictedCSSProperty(b.image.PanoramicView.RESTRICTED_STYLES,d)){throw new Error("You cannot set "+e+" : "+d+" CSS property for this component ")}else{this.superproto.setCSS.apply(this,[e,d,c])}};b.image.PanoramicView.prototype.setModifier=function(c){throw new Error("Trying to use setModifier on the Core class (PanoramicView) is unsupported! Please refer to SDK documentation on using setModifier.")};b.image.PanoramicView.prototype.setVRRender=function(c){throw new Error("Trying to use setVRRender on the Core class (PanoramicView) is unsupported! Please refer to SDK documentation on using setVRRender.")};b.image.PanoramicView.prototype.cleanUp=function(){if(this.reqAnimationFrame){window.cancelAnimationFrame(this.reqAnimationFrame);this.reqAnimationFrame=null}window.removeEventListener("deviceorientation",this.setOrientationControls_,true);b.Event.removeDOMListener(this.obj,"mousedown",this.mouseDownHandler,{capture:true});this.helperCanvas=null;if(this.helperImage){this.helperImage.src="";this.helperImage=null}if(this.controls){this.controls.dispose();this.controls=null}if(this.renderer){this.renderer.dispose();this.renderer=null}if(this.map){this.map.dispose();this.map=null}this.scene=null;this.camera=null;this.effect=null;this.wid=0;this.hei=0;this.reqHei=0;this.reqWid=0;var c=document.getElementById(this.id+"_specbtn");if(c){c.parentNode.removeChild(c)}b.Util.removeTags(this.obj);this.obj.style.cssText=""};b.image.PanoramicView.prototype.dispose=function(){this.cleanUp();if(this.obj){if(this.obj.parentElement){this.obj.parentElement.removeChild(this.obj)}}};b.image.PanoramicView.prototype.addEventListener=function(e,d,c){b.Logger.log(b.Logger.FINE,"s7sdk.image.PanoramicView.addEventListener - type: %0, handler: %1, useCapture: %2",e,d.toString().substring(0,d.toString().indexOf("(")),c);this.superproto.addEventListener.apply(this,[e,d,c])};b.image.PanoramicView.prototype.render=function(){var c=this;if(this.controls){this.controls.update();this.reqAnimationFrame=window.requestAnimationFrame(this.render);if(this.vrRender){this.effect.render(this.scene,this.camera)}else{this.renderer.render(this.scene,this.camera)}}};b.image.PanoramicView.prototype.setItem=function(d){b.Logger.log(b.Logger.FINE,"s7sdk.image.PanoramicView.setItem - item: %0",d);if(this.isReq){this.isReq.cancelHttpReq()}if(d instanceof b.ItemDesc==false){throw new Error("Item must be a descendant of ItemDesc!")}this.currentAsset=d;if(d.parent==null){throw new Error("ItemDesc must be part of a parent set!")}this.mediaSet=d.parent;this.viewIsReadySent=false;this.item=d;this.createView(this.item);var c=new b.event.StatusEvent(b.event.StatusEvent.NOTF_ASSET_METADATA_READY,true);b.Event.dispatch(this.obj,c,false)};b.image.PanoramicView.prototype.setOrientationControls=function(d){if(!d.alpha||!this.vrRender){return}this.controls=new b.libs.three.THREE.DeviceOrientationControls(this.camera,true);this.controls.connect();this.controls.update();var c=document.getElementById(this.id+"_specbtn");if(c){c.parentNode.removeChild(c)}window.removeEventListener("deviceorientation",this.setOrientationControls_,true)};b.image.PanoramicView.prototype.onLoadImage=function(){if(this.helperImage){if(this.helperCanvas){this.helperCanvas.width=this.reqWid=this.helperImage.width;this.helperCanvas.height=this.reqHei=this.helperImage.height}}if(this.initLoad){this.scene=new b.libs.three.THREE.Scene();this.camera=new b.libs.three.THREE.PerspectiveCamera(75,this.wid/this.hei,1,1000);this.camera.position.x=0.1;var g=new b.libs.three.THREE.SphereGeometry(500,60,40);g.scale(-1,1,1);var f={antialias:true};if("png-alpha"==this.fmt.toLowerCase()||"gif-alpha"==this.fmt.toLowerCase()){f.alpha=true;f.alphaPremultipliedAlpha=true}this.renderer=new b.libs.three.THREE.WebGLRenderer(f);this.renderer.setSize(this.wid,this.hei);this.effect=new b.libs.three.THREE.StereoEffect(this.renderer);this.effect.setSize(this.wid,this.hei);var c=this.helperCanvas.getContext("2d");c.drawImage(this.helperImage,0,0);this.map=new b.libs.three.THREE.CanvasTexture(this.helperCanvas);this.map.generateMipmaps=false;this.map.minFilter=b.libs.three.THREE.LinearFilter;this.map.magFilter=b.libs.three.THREE.LinearFilter;this.map.format=b.libs.three.THREE.RGBFormat;this.sphere=new b.libs.three.THREE.Mesh(g,new b.libs.three.THREE.MeshBasicMaterial({map:this.map}));this.scene.add(this.sphere);this.controls=new b.event.PanoramicController(this.camera,this.obj,this.autorotate);this.controls.autoRotateSpeed=0.5;var d=this;this.controls.onChangeCallback=function(){d.dispatchEvent(new b.event.PovEvent(b.event.PovEvent.NOTF_POV_CHANGE,d.getPov()))};this.setOrientationControls_=function(h){d.setOrientationControls(h)};window.addEventListener("deviceorientation",this.setOrientationControls_,true);this.mouseDownHandler=function(h){d.obj.focus()};b.Event.addDOMListener(this.obj,"mousedown",this.mouseDownHandler,{capture:true});this.obj.appendChild(this.renderer.domElement);this.initLoad=false;if(this.reqAnimationFrame){window.cancelAnimationFrame(this.reqAnimationFrame);this.reqAnimationFrame=null}if(!this.viewIsReadySent){var e=new b.event.StatusEvent(b.event.StatusEvent.NOTF_VIEW_READY,true);b.Event.dispatch(this,e,false);this.viewIsReadySent=true}this.render();this.initCalled=true}else{var c=this.helperCanvas.getContext("2d");c.drawImage(this.helperImage,0,0);this.sphere.material.map.needsUpdate=true}};b.image.PanoramicView.prototype.loadImage=function(c){var k=this;if(c){this.imageUrl=c}else{c=this.imageUrl}if(!c){b.Logger.log(b.Logger.FINE,"s7sdk.PanoramicView.loadImage - image url not available");return}var j=this.imageUrl+(this.imageUrl.indexOf("?")>=0?"&":"?")+"fmt="+this.fmt;var i=false;var l=true;var m=this.imageWidth/this.imageHeight;if(this.hei){var e=this.wid/this.hei;if(m<e){l=false}}else{i=true}var d=l?this.hei:this.wid;var n=Math.round(Math.pow(2,Math.ceil(Math.log(d)/Math.log(2))));if(i){j+="&scl=1"}else{if(l){n=Math.min(this.imageHeight,n);var h=n*m;if(h>this.imageWidth){l=false;n=this.imageWidth}}else{n=Math.min(this.imageWidth,n);var f=n/m;if(f>this.imageHeight){l=true;n=this.imageHeight}}j+=(l?"&hei=":"&wid=")+n}j+="&dpr=off";if(this.requestUrl!=j){function g(o){var q=window.document.createElement("a");var p=window.location.href;q.href=o;q.href=q.href;return q.protocol+q.hostname+q.port}this.helperImage=null;this.helperImage=new Image();this.helperImage.crossOrigin="anonymous";if(b.browser.name=="safari"){this.helperImage.removeAttribute("crossOrigin");if((g(j)!=g(window.location.href))){this.helperImage.setAttribute("crossOrigin","anonymous")}}this.helperImage.onload=function(){k.onLoadImage()};b.Logger.log(b.Logger.FINE,"s7sdk.PanoramicView.loadImage - requestUrl: %0",j);this.helperImage.src=j;this.requestUrl=j}};b.image.PanoramicView.prototype.loadRequest=function(c){this.mediaSet=b.MediaSetParser.parse(c.set,this.imageModifier);if(this.mediaSet.items.length>0&&this.mediaSet.items[0] instanceof b.ItemDesc){this.item=this.mediaSet.items[0];this.asset=this.item.name;this.imageWidth=this.item.width;this.imageHeight=this.item.height;this.createView(this.item);this.oldAsset=this.asset;var d=new b.event.StatusEvent(b.event.StatusEvent.NOTF_ASSET_METADATA_READY,true);b.Event.dispatch(this.obj,d,false)}else{throw new Error("Set response did not contain valid items! Set may be empty.")}};b.image.PanoramicView.prototype.createView=function(d){var f=d.name;this.imageWidth=d.width;this.imageHeight=d.height;if(d.label){this.obj.setAttribute("aria-label",d.label)}else{this.obj.removeAttribute("aria-label")}function c(h,g,i){h+=((h.indexOf("?")==-1)?"?":"&")+g;h+=(typeof i=="undefined")?"":"="+i;return h}if(this.iscommand!=null&&this.iscommand.length>0){f=c(f,this.iscommand)}if(b.Util.isNonEmptyString(this.locale)){f=c(f,"locale",this.locale)}if(b.Util.isNonEmptyString(d.version)){f=c(f,"id",d.version)}this.loadImage(b.Util.resolveURL(this.serverUrl,f));this.settings.trackLoad(this);if(this.oldAsset!=this.asset&&this.oldAsset!=null){var e=new b.AssetEvent(b.event.AssetEvent.ASSET_CHANGED,d,0,true);this.dispatchEvent(e)}};b.image.PanoramicView.prototype.setAsset=function(c){if(typeof c!="string"){throw new Error("Asset name must be represented by a string!")}b.Logger.log(b.Logger.FINE,"s7sdk.image.PanoramicView.setAsset - asset: %0",c);if(c==""){return}var f=this.asset;this.currentAsset=c;this.asset=unescape(c);this.mediaSet=null;this.viewIsReadySent=false;var d=b.Util.resolveURL(this.serverUrl,b.MediaSetParser.parseAssetForSetReq(this.asset).req);if(b.Util.isNonEmptyString(this.locale)){d+="&locale="+this.locale}if(this.isReq){this.isReq.cancelHttpReq()}this.isReq=new b.IS();this.isReq.getHttpReq(d,function(h,g){b.image.PanoramicView.prototype.loadRequest.apply(g,[h])},null,this);if(f!=this.asset&&f!=null){var e=new b.event.UserEvent(b.event.UserEvent.SWAP,[0,this.asset],true);b.Event.dispatch(this.obj,e,false)}};b.image.PanoramicView.prototype.getAsset=function(){return(this.asset?this.asset:this.mediaSet.name)};b.image.PanoramicView.prototype.getWidth=function(){return this.wid};b.image.PanoramicView.prototype.getHeight=function(){return this.hei};b.image.PanoramicView.prototype.resize=function(d,c){b.Logger.log(b.Logger.FINE,"s7sdk.image.PanoramicView.resize - width: %0, height: %1",d,c);if(d==this.wid&&c==this.hei){return}this.wid=d;this.hei=c;this.obj.style.width=this.wid+"px";this.obj.style.height=this.hei+"px";if(this.helperImage&&((!this.reqWid||!this.reqHei)||(this.hei>this.reqHei||this.wid>this.reqWid))&&(this.helperImage.width<this.imageWidth&&this.helperImage.height<this.imageHeight)){this.loadImage()}if(this.initCalled){this.camera.aspect=this.wid/this.hei;this.camera.updateProjectionMatrix();this.renderer.setSize(this.wid,this.hei);this.effect.setSize(this.wid,this.hei)}this.dispatchEvent(new b.event.ResizeEvent(b.event.ResizeEvent.COMPONENT_RESIZE,d,c,false));b.UIComponent.prototype.resize.apply(this,[d,c])};b.image.PanoramicView.prototype.getCurrentAsset=function(){return typeof this.currentAsset=="undefined"?null:this.currentAsset};b.image.PanoramicView.prototype.setCurrentAsset=function(c){this.viewIsReadySent=true;if(typeof(c)=="string"){this.setAsset(c)}else{this.setItem(c)}};b.image.PanoramicView.prototype.getPov=function(){if(this.controls){return new b.PovDesc(this.controls.lon,this.controls.lat)}else{return null}};b.image.PanoramicView.prototype.setPov=function(c){if(this.controls&&c){this.controls.lon=c.lon;this.controls.lat=c.lat;this.autoRotatePause()}};b.image.PanoramicView.prototype.autoRotatePause=function(){this.autoRotate=false;this.controls.autoRotate=this.autoRotate};b.image.PanoramicView.prototype.autoRotateResume=function(){this.autoRotate=true;this.controls.autoRotate=this.autoRotate};b.image.PanoramicView.prototype.symbols={ROLE_DESCRIPTION:"panoramic image",USAGE_HINT:"Use arrow keys to navigate in panoramic image",TRACK_DEVICE_ORIENTATION:"Track device orientation"};b.PanoramicView=b.image.PanoramicView;(function a(){var f=b.Util.css.createCssRuleText;var e=b.Util.css.createCssImgUrlText;var d=b.browser&&b.browser.name=="ie"&&b.browser.version.major>=10;var c=f(".s7panoramicview",{"width":"600px","height":"300px","position":"absolute","background-color":"transparent","user-select":"none","-moz-user-select":"-moz-none","-webkit-user-select":"none","-webkit-tap-highlight-color":"rgba(0,0,0,0)","text-align":"left","touch-action":d?"none":""})+f(".s7panoramicview .s7trackdeviceorientationbutton",{"position":"absolute","z-index":"999","text-align":"center","bottom":"90px","left":"calc(50% - 100px)","width":"200px","padding":"12px 6px","border":"1px solid #fff","background":"rgba(0,0,0,0.1)","color":"#fff","font":"normal 13px sans-serif","outline":"none","cursor":"pointer","user-select":"none","-moz-user-select":"-moz-none","-webkit-user-select":"none"});b.Util.css.addDefaultCSS(c,"PanoramicView")})()}})(s7getCurrentNameSpace());