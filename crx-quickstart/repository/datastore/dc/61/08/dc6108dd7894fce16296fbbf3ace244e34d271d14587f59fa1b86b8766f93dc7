/*!************************************************************************
*
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2013 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by trade secret or copyright law.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
if(typeof s7viewers == "undefined") {
	s7viewers = {};
}else if(typeof s7viewers != "object") {
	throw new Error("Cannot initialize a root 's7viewers' package. s7viewers is not an object");
}

if(!s7viewers.InteractiveImage) {
	(function(){
		var s7sdk;
		/**
		 * Construct a InteractiveImage object
		 * @param {Object} inObj optional simple JSON object that consists of name:value pairs for customization of the viewer.
		 */
		s7viewers.InteractiveImage = function (inObj) {
			this.sdkBasePath = '../../s7sdk/3.12/';
			this.codebaseRegEx = /\/etc\/dam\/viewers\//;
			this.containerId = null;
			this.params = {};
			this.handlers = [];
			this.onInitFail = null;
			this.initializationComplete = false;
			this.initCalled = false;
			this.isDisposed = false;
			this.utilsScriptElm = null;
			this.preloadImage = true;
			this.fixinputmarker = null;
			this.sdkProvided = false;			
			this.lockurldomains = true;

			if (typeof inObj == "object"){
				if (inObj.containerId) {
					this.setContainerId(inObj.containerId)
				}
				if (inObj.params) {
					for(var param in inObj.params) {
						if(inObj.params.hasOwnProperty(param) && inObj.params.propertyIsEnumerable(param)) {
							this.setParam(param,inObj.params[param]);
						}
					}
				}
				if (inObj.handlers) {
					this.setHandlers(inObj.handlers);
				}
				if (inObj.localizedTexts) {
					this.setLocalizedTexts(inObj.localizedTexts);
				}
			}
		};

		s7viewers.InteractiveImage.cssClassName = "s7interactiveimage";

		s7viewers.InteractiveImage.prototype.modifiers = {
			preloadImage: { params: ["preloadimage"], defaults: [false] }
		};

		s7viewers.InteractiveImage.prototype.setContainerId = function (inElemId) {
			if (this.isDisposed) return;
			this.containerId = inElemId || null;
		};
		
		s7viewers.InteractiveImage.getCodeBase = function() {
			var contentUrl = "";
			var viewerPath = "";
			var scriptTags = null;
			if (document.scripts){
				scriptTags = document.scripts;
			} else {
				scriptTags = document.getElementsByTagName("script");
			}

			for(var i=0; i<scriptTags.length;i++){
				var src = scriptTags[i].src;
				var result = /^\s*(http[s]?:\/\/[^\/]*)?(.*)(\/(js|js_orig)\/InteractiveImage\.js)/.exec(src);
				if (result && result.length == 5) {
					if ( typeof result[1] !== 'undefined' ) {
						contentUrl = result[1];
					}
					contentUrl += result[2];
					viewerPath = src;
					break;
				 }
			}
			if ((contentUrl != '') && (contentUrl.lastIndexOf('/') != contentUrl.length - 1)) {
				contentUrl += '/';
			}
			
			var codebaseRegEx = /\/etc\/dam\/viewers\//;
			s7viewers.InteractiveImage.codebase = {"contentUrl": contentUrl, "isDAM": codebaseRegEx.test(viewerPath)};
			
		};
		s7viewers.InteractiveImage.getCodeBase();
		
		s7viewers.InteractiveImage.prototype.getContentUrl = function () {
			return s7viewers.InteractiveImage.codebase.contentUrl;
		};

		s7viewers.InteractiveImage.prototype.symbols = {
			"Container.LABEL":"Interactive image",
			"QUICKVIEW_DISCLAIMER":"Example For Preview Only"
		};

		s7viewers.InteractiveImage.prototype.includeViewer = function () {
			s7sdk.Util.lib.include("s7sdk.common.Container");
			s7sdk.Util.lib.include("s7sdk.set.MediaSet");
			s7sdk.Util.lib.include("s7sdk.image.ZoomView");
			s7sdk.Util.lib.include("s7sdk.image.ImageMapEffect");			

			this.trackingManager = new s7sdk.TrackingManager(); // needs to be created first to track LOAD event

			var interactiveImageLocalizedTexts = {
				"en": this.symbols,
				defaultLocale: "en"
			};		

			this.s7params = new s7sdk.ParameterManager(null,null,{"asset" : "MediaSet.asset"},this.getContentUrl()+"InteractiveImage.css", this.lockurldomains);
			var viewerName = ""; 
			if (this.s7params.params.config && (typeof(this.s7params.params.config) == "string")) {
				viewerName = ",";
				if (this.s7params.params.config.indexOf("/") > -1) {
					viewerName += this.s7params.params.config.split('/')[1];
				} else 
					viewerName += this.s7params.params.config;
			}
			this.s7params.setViewer("508,5.17.1" + viewerName);

			this.s7params.setDefaultLocalizedTexts(interactiveImageLocalizedTexts);

			for(var prm in this.params){
				if (prm != "localizedtexts"){
					this.s7params.push(prm, this.params[prm]);
				}else{
					this.s7params.setLocalizedTexts(this.params[prm]);
				}
			}

			/* check viewer has "preview" modifier. If preview=true viewer loads InfoPanelPopup-library and creates infoPanelPopup-instance  */
			this.preview = false;
			if ((this.s7params.get("preview", "0") == "1") || (this.s7params.get("preview", "0").toLowerCase() == "true")){
				this.preview = true;
				s7sdk.Util.lib.include("s7sdk.info.InfoPanelPopup");
				this.s7params.push("InfoPanelPopup.template", "<info><![CDATA[<div id='"+this.containerId+"_s7assetpreviewID' class='s7assetpreview' ><img id='"+this.containerId+"_s7assetpreviewimgID' class='s7assetpreviewimg' src='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'></div>]]></info>");
			}	

			this.container = null;
			this.mediaSet = null; 
			this.zoomView = null;
			this.imageMapEffect = null;
			this.isOrientationMarkerForcedChanged = false;

			/*
				Example. Suppose:
				assetTemplate=SampleCo/$sku$_prod
				author enters sku=12345 in AEM editor
				serverurl=http://server/is/image
				In this case, product image URL will be http://server/is/image/SampleCo/12345_prod
			*/
	//		this.assetTemplate = (this.s7params.params.assettemplate && this.s7params.params.assettemplate != "") ? this.s7params.params.assettemplate :null;
	//		this.preview = (this.s7params.params.preview == "0" || this.s7params.params.preview == "false" || !this.s7params.params.preview) ? false :true;
			this.assetTemplate = null;

			var self = this;
			
			function initViewer(){
				
				self.s7params.push("aemmode",  s7viewers.InteractiveImage.codebase.isDAM  ? "1" : "0");
				
				self.s7params.push("ZoomView.iconeffect", "0,0,0,0");
				self.s7params.push("ZoomView.singleclick", "none");
				self.s7params.push("ZoomView.doubleclick", "none");
				self.s7params.push("ZoomView.swipe", "0");
				self.s7params.push("ImageMapEffect.rollover", "0");

				var tmpl = self.s7params.get("assettemplate", null);
				self.assetTemplate = (tmpl && tmpl != "") ? tmpl :null;
				
				/*get fixinputmarker*/
				var fixinputmarkerParam = self.getParam("fixinputmarker");
				if (fixinputmarkerParam) {
					self.fixinputmarker = (fixinputmarkerParam == "s7touchinput" || fixinputmarkerParam == "s7mouseinput") ? self.fixinputmarker = fixinputmarkerParam : null;
				};
				
				var urlParam = self.getURLParameter("fixinputmarker");
				if (urlParam){
					self.fixinputmarker = (urlParam == "s7touchinput" || urlParam == "s7mouseinput") ? self.fixinputmarker = urlParam : null;;
				};
				
				if (self.fixinputmarker){
					if(self.fixinputmarker === "s7mouseinput"){
						self.addClass(self.containerId,"s7mouseinput");
					}else if(self.fixinputmarker === "s7touchinput"){
						self.addClass(self.containerId,"s7touchinput");
					}
				}else{
					if (s7sdk.browser.supportsTouch()){
						self.addClass(self.containerId,"s7touchinput");
					}else{
						self.addClass(self.containerId,"s7mouseinput");
					}
				}

				var presetClasses = self.s7params.get("presetClasses");
				if (presetClasses && presetClasses.length > 0) {
					presetClasses.forEach(function(presetClass) {
						self.addClass(self.containerId, presetClass);
					});
				}
				
				self.parseMods();

				self.container = new s7sdk.common.Container(self.containerId, self.s7params, self.containerId+"_container");
				self.container.setCSS(".s7container", "visibility", "hidden");
				if(self.container.isInLayout()){
					completeInitViewer();
				} else {
					self.container.addEventListener(s7sdk.event.ResizeEvent.ADDED_TO_LAYOUT, completeInitViewer, false);
				}
			}
			
			function completeInitViewer(){
				self.container.removeEventListener(s7sdk.event.ResizeEvent.ADDED_TO_LAYOUT, completeInitViewer, false);

				// work-around for webkit issue with applying height:100% to the containing element
				var containerDiv = document.getElementById(self.containerId);
				var tempMinHeight = containerDiv.style.minHeight;
				containerDiv.style.minHeight = "1px";

				var testdiv = document.createElement("div");
				testdiv.style.position = "relative";
				testdiv.style.width = "100%";
				testdiv.style.height = "100%";
				containerDiv.appendChild(testdiv);
				var emptyViewerHeight = testdiv.offsetHeight;
				if (testdiv.offsetHeight <= 1){
					containerDiv.style.height = "100%";
					emptyViewerHeight = testdiv.offsetHeight;
				}
				containerDiv.removeChild(testdiv);
				containerDiv.style.minHeight = tempMinHeight;

				var responsive = false;
				switch(self.s7params.get("responsive", "auto")){
					case "fit":
						responsive = false;
						break;
					case "constrain":
						responsive = true;
						break;
					default :
						responsive = emptyViewerHeight == 0;
						break;
				}
				self.updateCSSMarkers();
				self.updateOrientationMarkers();
				if(self.container.isFixedSize()) { // free
					self.viewerMode = "fixed";
				} else {
					if(responsive) { // restrict
						self.viewerMode = "ratio";
					} else {
						self.viewerMode = "free";
					}
				}

				self.mediaSet = new s7sdk.set.MediaSet(null, self.s7params, self.containerId+"_mediaSet");
				self.trackingManager.attach(self.mediaSet);
				// ====================================== Event Listeners ====================================== //
				// Add MediaSet event listeners
				self.mediaSet.addEventListener(s7sdk.event.AssetEvent.NOTF_SET_PARSED, onSetParsed, false);
				// Add Container event listeners
				self.container.addEventListener(s7sdk.event.ResizeEvent.COMPONENT_RESIZE, onContainerResize,false);
				self.container.addEventListener(s7sdk.event.ResizeEvent.FULLSCREEN_RESIZE, onContainerFullScreen,false);	
				self.container.addEventListener(s7sdk.event.ResizeEvent.SIZE_MARKER_CHANGE, onContainerSizeMarkerChange,false);	
				
				self.zoomView = new s7sdk.image.ZoomView(self.container, self.s7params, self.containerId+"_zoomView");
				self.zoomView.addEventListener(s7sdk.event.StatusEvent.NOTF_HIGHRES_VIEW_READY, onZoomViewReady, false);
				if(s7sdk.browser.supportsTouch()){
					s7sdk.Event.addDOMListener(self.zoomView,"touchstart",function(event){
						event.stopPropagation();
					},false);				
					s7sdk.Event.addDOMListener(self.zoomView,"touchmove",function(event){
						event.stopPropagation();
					},false);		
					s7sdk.Event.addDOMListener(self.zoomView,"touchend",function(event){
						event.stopPropagation();
					},false);				
					s7sdk.Event.addDOMListener(self.zoomView,"touchcancel",function(event){
						event.stopPropagation();
					},false);				
				};

				s7sdk.Event.addDOMListener(self.container,"keydown",function(event){
					var keyCode = (event.which) ? event.which : event.keyCode;
					switch (keyCode){
						case s7sdk.Enum.KEY_CODE.NUM_PLUS:
						case s7sdk.Enum.KEY_CODE.PLUS:
						case s7sdk.Enum.KEY_CODE.NUM_MINUS:
						case s7sdk.Enum.KEY_CODE.MINUS:
							event.stopPropagation();
						break;
					}
				},true);				

				self.trackingManager.attach(self.zoomView);

				self.imageMapEffect = new s7sdk.image.ImageMapEffect(self.containerId+"_zoomView", self.s7params, self.containerId+"_imageMapEffect");
				// Add event listeners for image map rollover and target events
				self.imageMapEffect.addEventListener(s7sdk.RolloverKeyEvent.ROLLOVER_ACTIVATED,  rolloverKeyHandler, false);
				self.imageMapEffect.addEventListener(s7sdk.RolloverKeyEvent.ROLLOVER_DEACTIVATED,rolloverKeyHandler, false);			
				self.imageMapEffect.addEventListener(s7sdk.RolloverKeyEvent.TARGET_INDEX,rolloverKeyTargetHandler, false);
				self.imageMapEffect.addEventListener(s7sdk.RolloverKeyEvent.QUICKVIEW_ACTIVATED,quickViewActivateHandler, false);
				if (self.preview) {
					self.infoPanelPopup = new s7sdk.InfoPanelPopup(self.containerId, self.s7params, self.containerId+"_infoPanelPopup");
				}
				if(self.viewerMode == "ratio"){
					containerDiv.style.height = "auto";                
				}

				self.trackingManager.setCallback(proxyTrack);
				// AppMeasurementBridge only available when config2 modifier is present
				if ((typeof(AppMeasurementBridge) == "function") && (self.isConfig2Exist == true)){
					self.appMeasurementBridge = new AppMeasurementBridge(self.trackingParams);
				}

				// ====================================== Event Handlers ====================================== //
				function onSetParsed(e) {
					var mediaSetDesc = e.s7event.asset;

					if(self.viewerMode == "ratio"){
						var itm = mediaSetDesc.items[0];
						var assetRatio = itm.width/itm.height;
						self.container.setModifier({ "aspect": assetRatio });
					}
					resizeViewer(self.container.getWidth(), self.container.getHeight());//S7-8437
					self.zoomView.setItem(mediaSetDesc.items[0]);
					self.zoomView.removeEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, onImageChanged, false);
					self.zoomView.addEventListener(s7sdk.event.AssetEvent.ASSET_CHANGED, onImageChanged, false);

					if ((self.handlers["initComplete"] != null) && (typeof self.handlers["initComplete"] == "function")){
                        if (typeof window.s7sdk == "undefined") {
                            window.s7sdk = s7sdk;
						}
						self.handlers["initComplete"]();
					}
				}

				function onZoomViewReady(event){
					self.container.setCSS(".s7container", "visibility", "inherit");
					if (self.preloadImageElm){
						if(self.preloadImageElm.parentNode){
							self.preloadImageElm.parentNode.removeChild(self.preloadImageElm);
						}
						self.preloadImageElm = null;
					}
				}
				
				function onImageChanged(event) {
					if (self.imageMapEffect){
						self.imageMapEffect.reload();	
					}
				};
				
				//Container Resize handler
				function onContainerResize(event) {
					if((typeof(event.target) == 'undefined') || (event.target == document.getElementById(self.containerId+"_container"))) {
						if(!self.container.isInLayout()){
							return;
						}
						
						resizeViewer(event.s7event.w, event.s7event.h);
					}
				}
				
				//Container FullScreen Resize handler
				function onContainerFullScreen(event) {
					resizeViewer(event.s7event.w, event.s7event.h);
				}

				function onContainerSizeMarkerChange(event) {
					self.updateCSSMarkers();
				}
				
				//Resize viewer handler
				function resizeViewer(w,h){
					self.updateOrientationMarkers();
					self.zoomView.resize(w, h);
					if (self.infoPanelPopup) {
						self.infoPanelPopup.resize(w, h);
					}
				}
				
				// Define an event handler function to activate the InfoPanelPopup for image map rollovers
				function rolloverKeyHandler(event) {
					if (event.s7event.rolloverKey != null) {
						//
					}
				}
				
				function rolloverKeyTargetHandler(event) {
					if(event.s7event.frame) {
						//??
					}
				}

				function quickViewActivateHandler(event) {
					if(event.s7event.quickViewData) {
						var imgSrc = ""; 
						var prevWidth = null;
						var prevHeight = null;
						if (self.preview){
							self.infoPanelPopup.activateRollover(event.s7event.rolloverKey);
							var quickViewImg = document.getElementById(self.containerId+"_s7assetpreviewimgID");
							var quickViewImgCont = document.getElementById(self.containerId+"_s7assetpreviewID");
							var disclaimer = document.createElement("div");
							if (self.s7params.getLocalizedText("QUICKVIEW_DISCLAIMER") != undefined){
								disclaimer.innerText = self.s7params.getLocalizedText("QUICKVIEW_DISCLAIMER");
								disclaimer.className = "s7disclaimer";
								quickViewImgCont.parentNode.appendChild(disclaimer);
							}
							var stdimgSrc = quickViewImg.src;
							prevWidth = parseInt(s7sdk.Util.getStyle(quickViewImgCont, "width"));
							prevHeight = parseInt(s7sdk.Util.getStyle(quickViewImgCont, "height"));
							if (self.assetTemplate && event.s7event.quickViewData.sku){
								var tmplStr = self.assetTemplate;
								for (var i in event.s7event.quickViewData) {
									var tmpl = new RegExp(("$" + i.toUpperCase() + "$").replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'),"gi");
									tmplStr = tmplStr.replace(tmpl, event.s7event.quickViewData[i]);
								}
								imgSrc = tmplStr;
								if(!(self.assetTemplate.indexOf("http://") == 0) && !(self.assetTemplate.indexOf("https://") == 0)){
									if (self.mediaSet.component.serverUrl) {
										var serverURL = self.mediaSet.component.serverUrl;
										if(serverURL.lastIndexOf('/') != (serverURL.length - 1))
										serverURL += "/";
										if (prevWidth && prevHeight){
											imgSrc = serverURL + imgSrc;
											imgSrc += ((imgSrc.indexOf("?") == -1) ? "?" : "&") + "wid=" + parseInt(prevWidth) + "&hei=" + parseInt(prevHeight) ;
										} else {
											imgSrc = serverURL + imgSrc;
										}
									};
								}else{
									imgSrc = imgSrc;//absolute path to image
								}
							} else {
								imgSrc = quickViewImg.src;
								document.getElementById(self.containerId+"_s7assetpreviewimgID").src = stdimgSrc;
								document.getElementById(self.containerId+"_s7assetpreviewID").className += " s7genericimage";
							}

							quickViewImg.onload = function() {  
								//
							};  
							quickViewImg.onerror = quickViewImg.onabort = function() {  
								document.getElementById(self.containerId+"_s7assetpreviewimgID").src = stdimgSrc;
								document.getElementById(self.containerId+"_s7assetpreviewID").className += " s7genericimage";
								if (self.handlers["quickViewAssetMissing"]) {
									self.handlers["quickViewAssetMissing"](event.s7event.quickViewData, imgSrc, self.assetTemplate);
								}
							};  

							document.getElementById(self.containerId+"_s7assetpreviewimgID").src = imgSrc;
						}
						if (self.handlers["quickViewActivate"]) {
							self.handlers["quickViewActivate"](event.s7event.quickViewData);
						}
					}
				}

				function proxyTrack(objID, compClass, instName, timeStamp, eventInfo) {
					if(!self.handlers["trackEvent"] && self.isConfig2Exist != true && s7sdk.Modifier.parse(self.s7params.get("launch", "true"), [true]).values[0]) {
						if(typeof(_satellite) != 'undefined' && _satellite._dmviewers_v001) {
							self.handlers["trackEvent"] = _satellite._dmviewers_v001().trackingFn;
						}
					}
					if (self.appMeasurementBridge) {
						self.appMeasurementBridge.track(objID, compClass, instName, timeStamp, eventInfo);
					}
					if (self.handlers["trackEvent"]) {
                        if (typeof window.s7sdk == "undefined") {
                            window.s7sdk = s7sdk;
                        }
						var objID_ = self.containerId;
						self.handlers["trackEvent"](objID_, compClass, instName, timeStamp, eventInfo);
					}
					if ("s7ComponentEvent" in window) {
						s7ComponentEvent(objID, compClass, instName, timeStamp, eventInfo);
					}
				}
				
			}

			this.s7params.addEventListener(s7sdk.Event.SDK_READY,function(){
													self.initSiteCatalyst(self.s7params,initViewer);
											},false);
			this.s7params.setProvidedSdk(this.sdkProvided);
			this.s7params.init();	
		};


		s7viewers.InteractiveImage.prototype.setParam = function(key, def){
			if (this.isDisposed) return;
			this.params[key] = def;	
		};

		s7viewers.InteractiveImage.prototype.getParam = function(key){
			var keyLC = key.toLowerCase();
            for (var paramsKey in this.params) {
                if (paramsKey.toLowerCase() == keyLC) {
                    return this.params[paramsKey];
                }
            }
            return null; 
		};

		s7viewers.InteractiveImage.prototype.setParams = function(inParams){
			if (this.isDisposed) return;
			var params = inParams.split("&");
			for (var i = 0; i < params.length; i++) {
				var pair = params[i].split("=");
				if (pair.length > 1) {
					this.setParam(pair[0],decodeURIComponent(params[i].split("=")[1]));
				}
			}
		};
		
		s7viewers.InteractiveImage.prototype.s7sdkUtilsAvailable = function(){
			if (s7viewers.InteractiveImage.codebase.isDAM) {
				return typeof(s7viewers.s7sdk) != "undefined";
			} else {
				return (typeof(s7classic) != "undefined") && (typeof(s7classic.s7sdk) != "undefined");
			}
		};

		s7viewers.InteractiveImage.prototype.init = function(){
			if (this.isDisposed) return;
			if (this.initCalled) return;
			this.initCalled = true;
			if (this.initializationComplete) return this;

			this.lockurldomains = (Boolean(Number(this.params.lockurldomains)) || typeof this.params.lockurldomains == "undefined") ? 1 : 0;

			var containerDiv = document.getElementById(this.containerId);
			if (containerDiv.className != ""){
				if (containerDiv.className.indexOf(s7viewers.InteractiveImage.cssClassName) != -1){
					//
				}else{
					containerDiv.className += " "+s7viewers.InteractiveImage.cssClassName;
				}	
			}else{
				containerDiv.className = s7viewers.InteractiveImage.cssClassName;
			}

			/*preview image*/
			/*get preloadImage modifier*/
			var prelodParam = this.getParam("preloadImage");
			if (prelodParam) {
				this.preloadImage = (prelodParam == "1" || prelodParam == "true");
			}
			if (this.getURLParameter("preloadImage")){
				this.preloadImage = (this.getURLParameter("preloadImage")== "1" || this.getURLParameter("preloadImage")== "true");
			}
			/*try to get width and height for preview image*/
			if (this.preloadImage){
				var imgWidth, imgHeight;
				if (this.getURLParameter("stagesize")){
					imgWidth = this.getURLParameter("stagesize").split(",")[0];
					imgHeight = this.getURLParameter("stagesize").split(",")[1];			
				}
				else if (this.params.stagesize){
					imgWidth = this.params.stagesize.split(",")[0];
					imgHeight = this.params.stagesize.split(",")[1];
				}
				else {
					imgWidth = document.getElementById(this.containerId).offsetWidth;
					imgHeight = document.getElementById(this.containerId).offsetHeight;			
				}
				if (imgWidth > 0){
					this.preloadImageElm = new Image();
					this.preloadImageElm.style.position = "relative";
					this.preloadImageElm.draggable = false;
					this.preloadImageElm.style.pointerEvents = "none";
					var self = this;
					this.preloadImageElm.onload = function(){
						if (self.isDisposed) return;
						if (document.getElementById(self.containerId)){
							var container = document.getElementById(self.containerId);
                                                        if (self.getURLParameter("stagesize")){
                                                            this.style.width = self.getURLParameter("stagesize").split(",")[0]+"px";
                                                        }
                                                        else if (self.params.stagesize){
                                                            this.style.width  = self.params.stagesize.split(",")[0]+"px";
                                                        }
                                                        else {
                                                            this.style.width  = "100%";
                                                        }
							container.insertBefore(this,(container.hasChildNodes()) ? container.childNodes[0] : null);
						}
					}
					this.preloadImageElm.onerror = function(){
						//
					}
					/*form image url*/
					if ((this.params.asset || this.getURLParameter("asset"))&& (this.params.serverurl || this.getURLParameter("asset"))){
						var assetUrl, serverUrl, isCommand, imgUrl;
						isCommand = this.getURLParameter("iscommand") ? this.getURLParameter("iscommand") : this.params.iscommand;
						assetUrl = this.getURLParameter("asset") ? this.getURLParameter("asset") : this.params.asset;
						serverUrl = this.getURLParameter("serverurl") ? this.getURLParameter("serverurl") : this.params.serverurl;
						if (typeof serverUrl == "undefined") {
							serverUrl = "/is/image/";
						}
						if ((serverUrl.lastIndexOf('/') != serverUrl.length - 1)) {
							assetUrl= '/' + assetUrl;
						}
						imgUrl = serverUrl+assetUrl;
						//imgUrl = imgUrl+"?";
						if(imgWidth > 0){
							imgUrl = appendUrlArgument(imgUrl,"wid",imgWidth);
						}
						if(imgHeight > 0){
							imgUrl = appendUrlArgument(imgUrl,"hei",imgHeight);
						}
						if(isCommand){
							imgUrl = appendUrlArgument(imgUrl,isCommand);
						}					
						this.preloadImageElm.src = imgUrl;
					}
					else{
						this.preloadImageElm = null;
					}
				}
			}
			function appendUrlArgument(url, argname, value) {
				url += ((url.indexOf("?") == -1) ? "?" : "&") + argname;
				url += (typeof value == "undefined") ? "" : "=" + value;
				return url;
			}
			
			this.s7sdkNamespace = s7viewers.InteractiveImage.codebase.isDAM ? "s7viewers" : "s7classic";
			var utilSrcPath = this.getContentUrl() + this.sdkBasePath + "js/s7sdk/utils/Utils.js?namespace="+this.s7sdkNamespace;
			var allScripts = null;
			if (document.scripts){
				allScripts = document.scripts;
			}else{
				allScripts = document.getElementsByTagName("script");
			}

			if (this.s7sdkUtilsAvailable()){
				s7sdk = (s7viewers.InteractiveImage.codebase.isDAM ? s7viewers.s7sdk : s7classic.s7sdk);
				this.sdkProvided = true;
				if (this.isDisposed) {
					return;
				}
				s7sdk.Util.init(); 
				this.includeViewer(); 
				this.initializationComplete = true; 
			}else if (!this.s7sdkUtilsAvailable() && (s7viewers.InteractiveImage.codebase.isDAM ? s7viewers.S7SDK_S7VIEWERS_LOAD_STARTED : s7viewers.S7SDK_S7CLASSIC_LOAD_STARTED)){
				this.sdkProvided = true;
				var selfRef = this;
				var utilsWaitId = setInterval(
					function() {
						if (selfRef.s7sdkUtilsAvailable()) {
							clearInterval(utilsWaitId);
							s7sdk = (s7viewers.InteractiveImage.codebase.isDAM ? s7viewers.s7sdk : s7classic.s7sdk);
							if (selfRef.isDisposed) {
								return;
							}
							s7sdk.Util.init(); 
							selfRef.includeViewer();
							selfRef.initializationComplete = true;  
						}
					}, 100
				);
			}else{
				this.utilsScriptElm = document.createElement("script");
				this.utilsScriptElm.setAttribute("language", "javascript");
				this.utilsScriptElm.setAttribute("type", "text/javascript");

				var headElem = document.getElementsByTagName("head")[0];
				var self = this;

				function cleanupAndInitUtils() {
					if (!self.utilsScriptElm.executed) { 
						self.utilsScriptElm.executed = true;
						s7sdk = (s7viewers.InteractiveImage.codebase.isDAM ? s7viewers.s7sdk : s7classic.s7sdk);
						if (self.s7sdkUtilsAvailable() && s7sdk.Util){
							if (self.isDisposed) {
								return;
							}
							s7sdk.Util.init(); 
							self.includeViewer();  
							self.initializationComplete = true;
							self.utilsScriptElm.onreadystatechange = null;
							self.utilsScriptElm.onload = null;
							self.utilsScriptElm.onerror = null;
						}
					}  
				}

				if (typeof(self.utilsScriptElm.readyState) != "undefined") {
					self.utilsScriptElm.onreadystatechange =  function() {
						if (self.utilsScriptElm.readyState == "loaded") {
							headElem.appendChild(self.utilsScriptElm);
						} else if (self.utilsScriptElm.readyState == "complete") {
							cleanupAndInitUtils();
						}
					};
					self.utilsScriptElm.setAttribute("src", utilSrcPath);
				} else {
					self.utilsScriptElm.onload = function() {
						cleanupAndInitUtils();
					};
					self.utilsScriptElm.onerror = function() {
					};
					self.utilsScriptElm.setAttribute("src", utilSrcPath);
					headElem.appendChild(self.utilsScriptElm);
					self.utilsScriptElm.setAttribute("data-src", self.utilsScriptElm.getAttribute("src"));
					self.utilsScriptElm.setAttribute("src", "?namespace="+this.s7sdkNamespace);
				}
				if(s7viewers.InteractiveImage.codebase.isDAM) {
					s7viewers.S7SDK_S7VIEWERS_LOAD_STARTED = true;
				}else {
					s7viewers.S7SDK_S7CLASSIC_LOAD_STARTED = true;	
				}
			}
			
			return this;
		};
				
		s7viewers.InteractiveImage.prototype.getDomain = function(inUrl) {
			var res = /(^http[s]?:\/\/[^\/]+)/i.exec(inUrl);
			if (res == null) {
				return '';
			} else {
				return res[1];
			}
		};

		s7viewers.InteractiveImage.prototype.setAsset = function(inAsset) {
			if (this.isDisposed) return;
			if (this.mediaSet){
				this.mediaSet.setAsset(inAsset);
			}else{
				this.setParam("asset", inAsset);
			}
		};
		
		s7viewers.InteractiveImage.prototype.setLocalizedTexts = function(inText) {
			if (this.isDisposed) return;
			if (this.s7params){
				this.s7params.setLocalizedTexts(inText);
			}else{
				this.setParam("localizedtexts", inText);
			}
		};

		s7viewers.InteractiveImage.prototype.initSiteCatalyst = function(params,inCallback) {
				//integrate SiteCatalyst logging
				//strip modifier from asset and take the very first entry from the image list, and the first element in combination from that entry
				var siteCatalystAsset = params.get("asset", null, "MediaSet").split(',')[0].split(':')[0];
				this.isConfig2Exist = false;
				if (siteCatalystAsset.indexOf('/') != -1) {
					var company = s7sdk.MediaSetParser.findCompanyNameInAsset(siteCatalystAsset);
					var config2 = params.get("config2");
					this.isConfig2Exist = (config2 != '' && typeof config2 != "undefined");
					if (this.isConfig2Exist){
						this.trackingParams = {
							siteCatalystCompany: company,
							config2: config2,
							isRoot: params.get("serverurl")
						};
						var jsp_src =this.getContentUrl()+'../../AppMeasurementBridge.js?company=' + company + (config2 == '' ? '' : '&preset=' + config2);
						if (params.get("serverurl", null)) {
							jsp_src += "&isRoot=" + params.get("serverurl");
						}
						var elem = document.createElement("script");
						elem.setAttribute("language", "javascript");
						elem.setAttribute("type", "text/javascript");
						elem.setAttribute("src", jsp_src);

						var elems = document.getElementsByTagName("head");
						elem.onload = elem.onerror = function() {  
							if (!elem.executed) { 
								elem.executed = true;  
								if (typeof inCallback == "function"){
									inCallback();
								}
								elem.onreadystatechange = null;
								elem.onload = null;
								elem.onerror = null;
							}  
						};  

						elem.onreadystatechange = function() {  
							if (elem.readyState == "complete" || elem.readyState == "loaded") {  
								setTimeout(function() { 
									if (!elem.executed) { 
										elem.executed = true;  
										if (typeof inCallback == "function"){
											inCallback();
										}
									}  
									elem.onreadystatechange = null;
									elem.onload = null;
									elem.onerror = null;
								}, 0);
							}  
						};
						elems[0].appendChild(elem);
					}else{
						if (typeof inCallback == "function"){
							inCallback();
						}
					}	
				}
		};

		/**
		 * Return component within the viewer according the specified id, null if id is invalid or inapplicable.
		 * @param inId ID of the component to retrieve 
		 */
		s7viewers.InteractiveImage.prototype.getComponent = function(inId) {
			if (this.isDisposed) return null;
			switch(inId){
				case "container":
					return this.container || null;
				case "mediaSet":
					return this.mediaSet || null;
				case "zoomView":
					return this.zoomView || null;
				case "imageMapEffect":
					return this.imageMapEffect || null;
				case "infoPanelPopup":
					return this.infoPanelPopup || null;
				case "parameterManager":
					return this.s7params || null;
				default:
					return null;
			}
		};

		/**
		 * @private
		 * Assigns handler functions by names.  This function will clear the previous handler functions on the list.
		 * Non-function entries will be ignored.
		 *
		 * @param {Object} inObj Simple JSON object containing name:function pairs.
		 */
		s7viewers.InteractiveImage.prototype.setHandlers = function(inObj) {
			if (this.isDisposed) return;
			if (this.initCalled) return;
			this.handlers = [];
			for (var i in inObj) {
				if (!inObj.hasOwnProperty(i)) continue;
				if (typeof inObj[i] != "function") continue;
				this.handlers[i] = inObj[i];
			}
		};

		s7viewers.InteractiveImage.prototype.getModifiers = function() {
			return this.modifiers;
		};

		s7viewers.InteractiveImage.prototype.setModifier = function(modifierObject) {
			if (this.isDisposed) return;
			var modName, modDesc, modObj, modVal, parsedModifier, i;
			for(modName in modifierObject) {
				if(!this.modifiers.hasOwnProperty(modName)) {
					continue;
				}
				modDesc = this.modifiers[modName];
				
				try {
					modVal = modifierObject[modName];

					if (modDesc.parseParams === false) {
						parsedModifier = new s7sdk.Modifier([modVal  != "" ? modVal : modDesc.defaults[0]]);
					} else {
						parsedModifier = s7sdk.Modifier.parse(modVal, modDesc.defaults, modDesc.ranges);
					}

					if(parsedModifier.values.length == 1) {
						this[modName] = parsedModifier.values[0];
						this.setModifierInternal(modName);
					}
					else if(parsedModifier.values.length > 1) {
						modObj = {};
						for(i = 0; i < parsedModifier.values.length; i++) {
							modObj[modDesc.params[i]] = parsedModifier.values[i];
						}
						this[modName] = modObj;
						this.setModifierInternal(modName);
					}
				}
				catch(error) {
					throw new Error("Unable to process modifier: '"+ modName + "'. " + error);
				}
			}
		};

		s7viewers.InteractiveImage.prototype.setModifierInternal = function(modName) {
			switch (modName) {
				default :
					break;				
			}
		};

		s7viewers.InteractiveImage.prototype.parseMods = function () {
			var modName, modDesc, modObj, modVal, parsedModifier, i;
			
			for(modName in this.modifiers) {
				if(!this.modifiers.hasOwnProperty(modName)) {
					continue;
				}
				modDesc = this.modifiers[modName];
				
				try {
					modVal = this.s7params.get(modName, "");

					if (modDesc.parseParams === false) {
						parsedModifier = new s7sdk.Modifier([modVal  != "" ? modVal : modDesc.defaults[0]]);
					} else {
						parsedModifier = s7sdk.Modifier.parse(modVal, modDesc.defaults, modDesc.ranges);
					}

					if(parsedModifier.values.length == 1) {
						this[modName] = parsedModifier.values[0];
					}
					else if(parsedModifier.values.length > 1) {
						modObj = {};
						for(i = 0; i < parsedModifier.values.length; i++) {
							modObj[modDesc.params[i]] = parsedModifier.values[i];
						}
						this[modName] = modObj;
					}
				}
				catch(error) {
					throw new Error("Unable to process modifier: '"+ modName + "'. " + error);
				}
			}
		};

		/**
		 * @private
		 */
		s7viewers.InteractiveImage.prototype.updateCSSMarkers = function (){
			var sizeMarker = this.container.getSizeMarker();
			var newclass;
			if (sizeMarker == s7sdk.common.Container.SIZE_MARKER_NONE){
				return;
			}		
			if (sizeMarker == s7sdk.common.Container.SIZE_MARKER_LARGE){
				newclass = "s7size_large";
			}else{
				if (sizeMarker == s7sdk.common.Container.SIZE_MARKER_SMALL){
					newclass = "s7size_small";
				}else if (sizeMarker == s7sdk.common.Container.SIZE_MARKER_MEDIUM){
					newclass = "s7size_medium";
				}
			}
			if (this.containerId) {
				this.setNewSizeMarker(this.containerId, newclass);
			}
			this.reloadInnerComponents();
		};

		s7viewers.InteractiveImage.prototype.reloadInnerComponents = function () {
			var regCompArr = this.s7params.getRegisteredComponents();
			for(var i=0; i < regCompArr.length; i++){
				if (regCompArr[i] && regCompArr[i].restrictedStylesInvalidated()){
					regCompArr[i].reload();
				}
			}
		};
		
		s7viewers.InteractiveImage.prototype.setNewSizeMarker = function (elm, inClass) {
			var cls = document.getElementById(elm).className;
			var re = /^(.*)(s7size_small|s7size_medium|s7size_large)(.*)$/gi;
			var newcls;
			if(cls.match(re)){
				newcls = cls.replace(re,  "$1" + inClass + "$3");
			} else {
				newcls = cls + " " + inClass;
			}
			if(cls != newcls){
				document.getElementById(elm).className = newcls;
			}
		};

	/////////////////////////////////////////
	/*
		InteractiveImage - constructor
		setContainerId
		setParam
		setParams
		setLocalizedTexts
		getComponent
		setHandlers
		setAsset
		init    

		try to run your tests in cross-browser manner. When possible, have console open to capture JS errors.
		make sure that after dispose() there is no HTTP traffic coming out from the viewer
		make sure that after dispose() web page DOM does not have viewer elements, 
			 and viewer container is completely empty and does not even have CSS markers assigned
		make sure that all documented viewer API is noop and does not trigger errors after dispose()
		make sure it is possible to create, dispose and then create new viewer again and again many times in a row. 
			For this test:
				try re-creating the same viewer multiple times
				try re-creating different viewers in the same DOM container
				measure CPU/memory utilization. Memory use should not grow after you created and disposed a viewer many times
		verify fix for Container.dispose() (S7-6899)
	*/
		s7viewers.InteractiveImage.prototype.dispose = function () {
			if (this.appMeasurementBridge) {
				this.appMeasurementBridge.dispose();
				this.appMeasurementBridge = null;
			}
			if (this.trackingManager){
				this.trackingManager.dispose();
				this.trackingManager = null;
			}
			if (this.visibilityManagerZoom){
				this.visibilityManagerZoom.dispose();
				this.visibilityManagerZoom = null;
			}
			if (this.imageMapEffect){
				this.imageMapEffect.dispose();
				this.imageMapEffect = null;
			}
			if (this.infoPanelPopup){
				this.infoPanelPopup.dispose();
				this.infoPanelPopup = null;
			}
			if (this.zoomView){
				this.zoomView.dispose();
				this.zoomView = null;
			}
			if (this.preloadImageElm){
				if (this.preloadImageElm.parentNode){
					this.preloadImageElm.parentNode.removeChild(this.preloadImageElm);
				}
				this.preloadImageElm = null;
			}
			if (this.mediaSet){
				this.mediaSet.dispose();
				this.mediaSet = null;
			}
			if (this.s7params){
				this.s7params.dispose();
				this.s7params = null;
			}
			if (this.container){
				var classes = [s7viewers.InteractiveImage.cssClassName,"s7touchinput","s7mouseinput","s7size_large","s7size_small","s7size_medium"];
				var cls = document.getElementById(this.containerId).className.split(' ');
				for(var i=0; i<classes.length;i++){
					var idx = cls.indexOf(classes[i]);
					if(idx != -1) { 
						cls.splice(idx, 1);
					}
				}
				document.getElementById(this.containerId).className = cls.join(' ');
				this.container.dispose();
				this.container = null;
			}
			this.handlers = [];
			this.isDisposed = true;
		};

		/**
		 * @private
		 */	
		s7viewers.InteractiveImage.prototype.updateOrientationMarkers = function (){
			if(!this.isOrientationMarkerForcedChanged){
				var newclass;
				if (window.innerWidth > window.innerHeight){
					newclass = "s7device_landscape";
				}else{
					newclass = "s7device_portrait";
				}			
				if (document.getElementById(this.containerId).className.indexOf(newclass) == -1) {
					this.setNewOrientationMarker(this.containerId, newclass);
					this.reloadInnerComponents();
				}
			}
		};
		
		s7viewers.InteractiveImage.prototype.setNewOrientationMarker = function (elm, inClass) {
			var cls = document.getElementById(elm).className;
			var re = /^(.*)(s7device_landscape|s7device_portrait)(.*)$/gi;
			var newcls;
			if(cls.match(re)){
				newcls = cls.replace(re,  "$1" + inClass + "$3");
			} else {
				newcls = cls + " " + inClass;
			}
			if(cls != newcls){
				document.getElementById(elm).className = newcls;
			}
		};

		s7viewers.InteractiveImage.prototype.forceDeviceOrientationMarker = function (marker){
			switch (marker){
				case "s7device_portrait":
				case "s7device_landscape":
					this.isOrientationMarkerForcedChanged = true;
					if (this.containerId) {
						this.setNewOrientationMarker(this.containerId, marker);
					}
					this.reloadInnerComponents();
					break;
				case null:
					this.isOrientationMarkerForcedChanged = false;
					this.updateOrientationMarkers();
					break;
				default:
					break;
			}
		};

		s7viewers.InteractiveImage.prototype.getURLParameter = function (name) {
			var resu = null;
			if (name !== "lockurldomains"){
				var resu = decodeURIComponent((new RegExp('[?|&]' + name + '=([^&;]+?)(&|#|;|$)','gi').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
				var verUrls = ["serverurl","contenturl","videoserverurl","emailurl","infoserverurl","searchserverurl"];
				if (verUrls.indexOf(name)!= -1){
					var allReg = /^((https?)\:\/\/)(([a-z0-9-])+\.)*(scene7\.com|adobe\.com|assetsadobe\.com|macromedia\.com)/gi;
					var currentDomain = this.getDomain(location);
					if (this.params.lockurldomains == undefined){
						this.params.lockurldomains = "1";
					}		
					if (this.params.lockurldomains === "1"){
						var checkDomain = /(^http[s]?:\/\/[^\/]+)?([^\\?#]*)/.exec(resu);
						checkDomain = checkDomain == null ? "":checkDomain[1];
						if (checkDomain != undefined && checkDomain != "" && checkDomain != currentDomain && resu.match(allReg) == null){
							resu = null;
						}
					}
				}
			}
			return resu;
		};

		s7viewers.InteractiveImage.prototype.addClass = function (elm, inClass) {
			var cls = document.getElementById(elm).className.split(' ');
			if(cls.indexOf(inClass) == -1) {
				cls[cls.length] = inClass;
				document.getElementById(elm).className = cls.join(' ');
			}
		};

	})();		
}
